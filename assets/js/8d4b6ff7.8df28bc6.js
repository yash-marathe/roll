"use strict";(globalThis.webpackChunkdocs_roll=globalThis.webpackChunkdocs_roll||[]).push([[2420],{23:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>p,contentTitle:()=>l,default:()=>_,frontMatter:()=>i,metadata:()=>o,toc:()=>c});var a=r(8168),t=(r(6540),r(5680));const i={},l="\u5e38\u89c1\u95ee\u9898\u89e3\u7b54 (Q&A)",o={unversionedId:"\u7b80\u4f53\u4e2d\u6587/\u5feb\u901f\u5f00\u59cb/qa_issues",id:"\u7b80\u4f53\u4e2d\u6587/\u5feb\u901f\u5f00\u59cb/qa_issues",title:"\u5e38\u89c1\u95ee\u9898\u89e3\u7b54 (Q&A)",description:"\u672c\u6587\u6863\u6574\u7406\u4e86\u4f7f\u7528 ROLL \u6846\u67b6\u65f6\u53ef\u80fd\u9047\u5230\u7684\u5e38\u89c1\u95ee\u9898\u53ca\u5176\u89e3\u51b3\u65b9\u6848\u3002",source:"@site/docs/\u7b80\u4f53\u4e2d\u6587/\u5feb\u901f\u5f00\u59cb/qa_issues.md",sourceDirName:"\u7b80\u4f53\u4e2d\u6587/\u5feb\u901f\u5f00\u59cb",slug:"/\u7b80\u4f53\u4e2d\u6587/\u5feb\u901f\u5f00\u59cb/qa_issues",permalink:"/ROLL/docs/\u7b80\u4f53\u4e2d\u6587/\u5feb\u901f\u5f00\u59cb/qa_issues",draft:!1,editUrl:"https://github.com/alibaba/ROLL/tree/main/docs_roll/docs/\u7b80\u4f53\u4e2d\u6587/\u5feb\u901f\u5f00\u59cb/qa_issues.md",tags:[],version:"current",lastUpdatedAt:1761727400,formattedLastUpdatedAt:"Oct 29, 2025",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"\u5feb\u901f\u4e0a\u624b\uff1a\u591a\u8282\u70b9\u90e8\u7f72\u6307\u5357",permalink:"/ROLL/docs/\u7b80\u4f53\u4e2d\u6587/\u5feb\u901f\u5f00\u59cb/multi_nodes_quick_start_cn"},next:{title:"\u5feb\u901f\u4e0a\u624b\uff1a\u5355\u673a\u7248\u90e8\u7f72\u6307\u5357",permalink:"/ROLL/docs/\u7b80\u4f53\u4e2d\u6587/\u5feb\u901f\u5f00\u59cb/single_node_quick_start_cn"}},p={},c=[{value:"\u6a21\u578b\u8f6c\u6362\u76f8\u5173",id:"\u6a21\u578b\u8f6c\u6362\u76f8\u5173",level:2},{value:"Megatron \u6a21\u578b\u5982\u4f55\u8f6c\u6210 HF \u683c\u5f0f\uff1f",id:"megatron-\u6a21\u578b\u5982\u4f55\u8f6c\u6210-hf-\u683c\u5f0f",level:3},{value:"\u8d44\u6e90\u914d\u7f6e\u76f8\u5173",id:"\u8d44\u6e90\u914d\u7f6e\u76f8\u5173",level:2},{value:"\u4ec0\u4e48\u662f colocate\uff08\u5171\u7f6e\uff09\u6a21\u5f0f\uff1f",id:"\u4ec0\u4e48\u662f-colocate\u5171\u7f6e\u6a21\u5f0f",level:3},{value:"\u4ec0\u4e48\u662f\u5206\u79bb\u6a21\u5f0f\uff1f",id:"\u4ec0\u4e48\u662f\u5206\u79bb\u6a21\u5f0f",level:3},{value:"\u8bad\u7ec3\u53c2\u6570\u76f8\u5173",id:"\u8bad\u7ec3\u53c2\u6570\u76f8\u5173",level:2},{value:"<code>rollout_batch_size</code> \u548c <code>num_return_sequences_in_group</code> \u662f\u4ec0\u4e48\u610f\u601d\uff1f",id:"rollout_batch_size-\u548c-num_return_sequences_in_group-\u662f\u4ec0\u4e48\u610f\u601d",level:3},{value:"\u5982\u4f55\u8bbe\u7f6e <code>gradient_accumulation_steps</code> \u548c <code>per_device_train_batch_size</code>\uff1f",id:"\u5982\u4f55\u8bbe\u7f6e-gradient_accumulation_steps-\u548c-per_device_train_batch_size",level:3},{value:"\u5bf9\u4e8e DeepSpeed Backend\uff1a",id:"\u5bf9\u4e8e-deepspeed-backend",level:4},{value:"\u5bf9\u4e8e Megatron Backend\uff1a",id:"\u5bf9\u4e8e-megatron-backend",level:4},{value:"\u8c03\u8bd5\u4e0e\u6027\u80fd\u5206\u6790\u76f8\u5173",id:"\u8c03\u8bd5\u4e0e\u6027\u80fd\u5206\u6790\u76f8\u5173",level:2},{value:"\u5982\u4f55\u83b7\u53d6\u8bad\u7ec3\u7684 timeline\uff1f",id:"\u5982\u4f55\u83b7\u53d6\u8bad\u7ec3\u7684-timeline",level:3},{value:"\u5982\u4f55 debug \u4ee3\u7801\uff1f",id:"\u5982\u4f55-debug-\u4ee3\u7801",level:3},{value:"\u5e38\u89c1\u9519\u8bef\u53ca\u89e3\u51b3\u65b9\u6848",id:"\u5e38\u89c1\u9519\u8bef\u53ca\u89e3\u51b3\u65b9\u6848",level:2},{value:"\u9519\u8bef\uff1a<code>self.node2pg[node_rank] KeyError: 1</code>",id:"\u9519\u8befselfnode2pgnode_rank-keyerror-1",level:3},{value:"\u9519\u8bef\uff1a<code>assert self.lr_decay_steps &gt; 0</code>",id:"\u9519\u8befassert-selflr_decay_steps--0",level:3},{value:"\u9519\u8bef\uff1a<code>AssertionError: batch_size 32 &lt; chunks 64</code>",id:"\u9519\u8befassertionerror-batch_size-32--chunks-64",level:3},{value:"\u9519\u8bef\uff1a<code>TypeError: BackendCompilerFailed.__init__() missing 1 required positional argument</code>",id:"\u9519\u8beftypeerror-backendcompilerfailed__init__-missing-1-required-positional-argument",level:3}],d={toc:c},s="wrapper";function _({components:e,...n}){return(0,t.yg)(s,(0,a.A)({},d,n,{components:e,mdxType:"MDXLayout"}),(0,t.yg)("h1",{id:"\u5e38\u89c1\u95ee\u9898\u89e3\u7b54-qa"},"\u5e38\u89c1\u95ee\u9898\u89e3\u7b54 (Q&A)"),(0,t.yg)("p",null,"\u672c\u6587\u6863\u6574\u7406\u4e86\u4f7f\u7528 ROLL \u6846\u67b6\u65f6\u53ef\u80fd\u9047\u5230\u7684\u5e38\u89c1\u95ee\u9898\u53ca\u5176\u89e3\u51b3\u65b9\u6848\u3002"),(0,t.yg)("h2",{id:"\u6a21\u578b\u8f6c\u6362\u76f8\u5173"},"\u6a21\u578b\u8f6c\u6362\u76f8\u5173"),(0,t.yg)("h3",{id:"megatron-\u6a21\u578b\u5982\u4f55\u8f6c\u6210-hf-\u683c\u5f0f"},"Megatron \u6a21\u578b\u5982\u4f55\u8f6c\u6210 HF \u683c\u5f0f\uff1f"),(0,t.yg)("p",null,"\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\u8fdb\u884c\u683c\u5f0f\u8f6c\u6362\uff1a"),(0,t.yg)("pre",null,(0,t.yg)("code",{parentName:"pre",className:"language-bash"},"python mcore_adapter/tools/convert.py --checkpoint_path path_to_megatron_model --output_path path_to_output_hf_model\n")),(0,t.yg)("h2",{id:"\u8d44\u6e90\u914d\u7f6e\u76f8\u5173"},"\u8d44\u6e90\u914d\u7f6e\u76f8\u5173"),(0,t.yg)("h3",{id:"\u4ec0\u4e48\u662f-colocate\u5171\u7f6e\u6a21\u5f0f"},"\u4ec0\u4e48\u662f colocate\uff08\u5171\u7f6e\uff09\u6a21\u5f0f\uff1f"),(0,t.yg)("p",null,"\u5728\u5171\u7f6e\u6a21\u5f0f\u4e0b\uff0c\u591a\u4e2a\u89d2\u8272\uff08\u5982 ",(0,t.yg)("inlineCode",{parentName:"p"},"actor_train"),"\u3001",(0,t.yg)("inlineCode",{parentName:"p"},"actor_infer"),"\u3001",(0,t.yg)("inlineCode",{parentName:"p"},"reference"),"\uff09\u7684 ",(0,t.yg)("inlineCode",{parentName:"p"},"device_mapping")," \u53ef\u4ee5\u590d\u7528\u76f8\u540c\u7684 GPU \u8bbe\u5907\u3002\u4f8b\u5982\uff1a"),(0,t.yg)("pre",null,(0,t.yg)("code",{parentName:"pre",className:"language-yaml"},"actor_train:\n  device_mapping: list(range(0,8))\nactor_infer:\n  device_mapping: list(range(0,8))\nreference:\n  device_mapping: list(range(0,8))\n")),(0,t.yg)("p",null,"\u6846\u67b6\u5e95\u5c42\u901a\u8fc7\u8d44\u6e90\u7ba1\u7406\u673a\u5236\u4fdd\u8bc1\u4e86\u591a\u4e2a\u89d2\u8272\u95f4 GPU \u7684\u590d\u7528\uff0c\u63d0\u9ad8\u8d44\u6e90\u5229\u7528\u7387\u3002"),(0,t.yg)("h3",{id:"\u4ec0\u4e48\u662f\u5206\u79bb\u6a21\u5f0f"},"\u4ec0\u4e48\u662f\u5206\u79bb\u6a21\u5f0f\uff1f"),(0,t.yg)("p",null,"\u5728\u5206\u79bb\u6a21\u5f0f\u4e0b\uff0c\u4e0d\u540c\u89d2\u8272\u7684 ",(0,t.yg)("inlineCode",{parentName:"p"},"device_mapping")," \u4e4b\u95f4\u6ca1\u6709\u4ea4\u96c6\uff0c\u6bcf\u4e2a\u89d2\u8272\u6301\u6709\u4e00\u7ec4\u72ec\u7acb\u7684 GPU \u8bbe\u5907\u8d44\u6e90\u3002\u4f8b\u5982\uff1a"),(0,t.yg)("pre",null,(0,t.yg)("code",{parentName:"pre",className:"language-yaml"},"actor_train:\n  device_mapping: list(range(0,8))\nactor_infer:\n  device_mapping: list(range(8,16))\nreference:\n  device_mapping: list(range(16,24))\n")),(0,t.yg)("p",null,"\u8fd9\u79cd\u65b9\u5f0f\u53ef\u4ee5\u907f\u514d\u89d2\u8272\u95f4\u7684\u8d44\u6e90\u7ade\u4e89\uff0c\u63d0\u9ad8\u7cfb\u7edf\u7a33\u5b9a\u6027\u3002"),(0,t.yg)("h2",{id:"\u8bad\u7ec3\u53c2\u6570\u76f8\u5173"},"\u8bad\u7ec3\u53c2\u6570\u76f8\u5173"),(0,t.yg)("h3",{id:"rollout_batch_size-\u548c-num_return_sequences_in_group-\u662f\u4ec0\u4e48\u610f\u601d"},(0,t.yg)("inlineCode",{parentName:"h3"},"rollout_batch_size")," \u548c ",(0,t.yg)("inlineCode",{parentName:"h3"},"num_return_sequences_in_group")," \u662f\u4ec0\u4e48\u610f\u601d\uff1f"),(0,t.yg)("ul",null,(0,t.yg)("li",{parentName:"ul"},(0,t.yg)("inlineCode",{parentName:"li"},"rollout_batch_size"),"\uff1a\u4e00\u4e2a batch \u4e2d\u7684 prompt \u6570\u91cf"),(0,t.yg)("li",{parentName:"ul"},(0,t.yg)("inlineCode",{parentName:"li"},"num_return_sequences_in_group"),"\uff1a\u9488\u5bf9\u6bcf\u6761 prompt \u7684\u91c7\u6837\u6570\uff0c\u5373 vLLM/SGLang \u63a8\u7406\u4e2d\u901a\u5e38\u610f\u4e49\u4e0a\u7684 n \u53c2\u6570")),(0,t.yg)("p",null,"\u5b9e\u9645\u4e00\u4e2a batch \u5185\u7684\u6837\u672c\u6570 = ",(0,t.yg)("inlineCode",{parentName:"p"},"rollout_batch_size")," * ",(0,t.yg)("inlineCode",{parentName:"p"},"num_return_sequences_in_group")),(0,t.yg)("p",null,"\u5bf9\u4e8e Megatron Backend\uff0c\u9700\u8981\u6ce8\u610f\uff1a"),(0,t.yg)("pre",null,(0,t.yg)("code",{parentName:"pre"},"rollout_batch_size * num_return_sequences_in_group \u5fc5\u987b\u662f\u4ee5\u4e0b\u503c\u7684\u6574\u6570\u500d\uff1a\ngradient_accumulation_steps * per_device_train_batch_size * (world_size/tensor_model_parallel_size/pipeline_model_parallel_size/context_parallel_size)\n")),(0,t.yg)("h3",{id:"\u5982\u4f55\u8bbe\u7f6e-gradient_accumulation_steps-\u548c-per_device_train_batch_size"},"\u5982\u4f55\u8bbe\u7f6e ",(0,t.yg)("inlineCode",{parentName:"h3"},"gradient_accumulation_steps")," \u548c ",(0,t.yg)("inlineCode",{parentName:"h3"},"per_device_train_batch_size"),"\uff1f"),(0,t.yg)("h4",{id:"\u5bf9\u4e8e-deepspeed-backend"},"\u5bf9\u4e8e DeepSpeed Backend\uff1a"),(0,t.yg)("pre",null,(0,t.yg)("code",{parentName:"pre"},"global_batch_size = per_device_train_batch_size * gradient_accumulation_steps * world_size\n")),(0,t.yg)("p",null,"\u5176\u4e2d ",(0,t.yg)("inlineCode",{parentName:"p"},"world_size")," \u5373 ",(0,t.yg)("inlineCode",{parentName:"p"},"actor_train"),"/",(0,t.yg)("inlineCode",{parentName:"p"},"critic")," \u7684 ",(0,t.yg)("inlineCode",{parentName:"p"},"device_mapping")," \u957f\u5ea6"),(0,t.yg)("h4",{id:"\u5bf9\u4e8e-megatron-backend"},"\u5bf9\u4e8e Megatron Backend\uff1a"),(0,t.yg)("pre",null,(0,t.yg)("code",{parentName:"pre"},"global_batch_size = per_device_train_batch_size * gradient_accumulation_steps * world_size / \n                    tensor_model_parallel_size / pipeline_model_parallel_size / context_parallel_size\n")),(0,t.yg)("p",null,"\u5176\u4e2d ",(0,t.yg)("inlineCode",{parentName:"p"},"world_size")," \u5373 ",(0,t.yg)("inlineCode",{parentName:"p"},"actor_train"),"/",(0,t.yg)("inlineCode",{parentName:"p"},"critic")," \u7684 ",(0,t.yg)("inlineCode",{parentName:"p"},"device_mapping")," \u957f\u5ea6"),(0,t.yg)("p",null,"\u6ce8\u610f\uff1a\u4e0d\u9700\u8981\u9664\u4ee5 ",(0,t.yg)("inlineCode",{parentName:"p"},"expert_model_parallel_size")),(0,t.yg)("h2",{id:"\u8c03\u8bd5\u4e0e\u6027\u80fd\u5206\u6790\u76f8\u5173"},"\u8c03\u8bd5\u4e0e\u6027\u80fd\u5206\u6790\u76f8\u5173"),(0,t.yg)("h3",{id:"\u5982\u4f55\u83b7\u53d6\u8bad\u7ec3\u7684-timeline"},"\u5982\u4f55\u83b7\u53d6\u8bad\u7ec3\u7684 timeline\uff1f"),(0,t.yg)("p",null,"\u53ef\u4ee5\u5c1d\u8bd5\u5728 YAML \u4e2d\u5f00\u542f profile\uff1a"),(0,t.yg)("pre",null,(0,t.yg)("code",{parentName:"pre",className:"language-yaml"},'system_envs:\n  RAY_PROFILING: "1"\nprofiler_output_dir: /data/oss_bucket_0/yali/llm/profile/${exp_name}\n')),(0,t.yg)("p",null,"\u7136\u540e\u5229\u7528 ",(0,t.yg)("a",{parentName:"p",href:"https://ui.perfetto.dev/"},"Perfetto UI")," \u5de5\u5177\u8fdb\u884c\u5206\u6790\u3002"),(0,t.yg)("h3",{id:"\u5982\u4f55-debug-\u4ee3\u7801"},"\u5982\u4f55 debug \u4ee3\u7801\uff1f"),(0,t.yg)("p",null,"\u5728 Platform \u7684 env \u4e2d\u8bbe\u7f6e ",(0,t.yg)("inlineCode",{parentName:"p"},'"RAY_DEBUG": "legacy"'),"\uff0c\u5c31\u53ef\u4ee5\u91c7\u7528 pdb \u8fdb\u884c\u5355\u6b65\u8c03\u8bd5\u3002"),(0,t.yg)("h2",{id:"\u5e38\u89c1\u9519\u8bef\u53ca\u89e3\u51b3\u65b9\u6848"},"\u5e38\u89c1\u9519\u8bef\u53ca\u89e3\u51b3\u65b9\u6848"),(0,t.yg)("h3",{id:"\u9519\u8befselfnode2pgnode_rank-keyerror-1"},"\u9519\u8bef\uff1a",(0,t.yg)("inlineCode",{parentName:"h3"},"self.node2pg[node_rank] KeyError: 1")),(0,t.yg)("p",null,"\u68c0\u67e5\u7533\u8bf7\u7684 GPU \u603b\u6570\u548c ",(0,t.yg)("inlineCode",{parentName:"p"},"device_mapping")," \u7684\u914d\u7f6e\u3002\u51fa\u73b0\u8be5\u9519\u8bef\u4e00\u822c\u662f\u56e0\u4e3a ",(0,t.yg)("inlineCode",{parentName:"p"},"max(device_mapping)")," \u5c0f\u4e8e\u6216\u5927\u4e8e ",(0,t.yg)("inlineCode",{parentName:"p"},"total_gpu_nums"),"\u3002"),(0,t.yg)("h3",{id:"\u9519\u8befassert-selflr_decay_steps--0"},"\u9519\u8bef\uff1a",(0,t.yg)("inlineCode",{parentName:"h3"},"assert self.lr_decay_steps > 0")),(0,t.yg)("p",null,"ROLL \u6570\u636e\u5206\u914d\u65f6\uff0c\u4f1a\u5c06 ",(0,t.yg)("inlineCode",{parentName:"p"},"rollout_batch_size")," \u7684\u6837\u672c\u6309 DP size \u5206\u53d1\u5230\u6bcf\u4e2a ",(0,t.yg)("inlineCode",{parentName:"p"},"actor_train")," worker \u4e0a\uff0c\u7136\u540e\u518d\u6309 ",(0,t.yg)("inlineCode",{parentName:"p"},"gradient_accumulation_steps")," \u8ba1\u7b97\u6bcf\u6b21\u68af\u5ea6\u66f4\u65b0\u7684\u6837\u672c\u3002\u914d\u7f6e\u4e00\u9664\u5c31\u662f 0\u3002"),(0,t.yg)("p",null,"\u8be6\u7ec6\u914d\u7f6e\u903b\u8f91\u53ef\u4ee5\u53c2\u8003\u624b\u518c\uff1a",(0,t.yg)("a",{parentName:"p",href:"https://alibaba.github.io/ROLL/docs/English/QuickStart/config_guide#training-arguments-training_args"},"Training Arguments")),(0,t.yg)("h3",{id:"\u9519\u8befassertionerror-batch_size-32--chunks-64"},"\u9519\u8bef\uff1a",(0,t.yg)("inlineCode",{parentName:"h3"},"AssertionError: batch_size 32 < chunks 64")),(0,t.yg)("p",null,(0,t.yg)("inlineCode",{parentName:"p"},"batch_size")," \u5c0f\u4e8e ",(0,t.yg)("inlineCode",{parentName:"p"},"reference"),"/",(0,t.yg)("inlineCode",{parentName:"p"},"actor_train")," \u7684 DP size\uff0c\u5bfc\u81f4 dispatch \u65f6\u6570\u636e\u4e0d\u591f\u5207\u5206\uff0c\u53ef\u4ee5\u8c03\u6574 ",(0,t.yg)("inlineCode",{parentName:"p"},"rollout_batch_size")," \u89e3\u51b3\u3002"),(0,t.yg)("h3",{id:"\u9519\u8beftypeerror-backendcompilerfailed__init__-missing-1-required-positional-argument"},"\u9519\u8bef\uff1a",(0,t.yg)("inlineCode",{parentName:"h3"},"TypeError: BackendCompilerFailed.__init__() missing 1 required positional argument")),(0,t.yg)("p",null,"\u53ef\u4ee5\u5c1d\u8bd5\u5728 YAML \u4e2d\u589e\u52a0\u914d\u7f6e\u9879\u89e3\u51b3\uff1a"),(0,t.yg)("pre",null,(0,t.yg)("code",{parentName:"pre",className:"language-yaml"},"system_envs:\n  NVTE_TORCH_COMPILE: '0'\n")))}_.isMDXComponent=!0},5680:(e,n,r)=>{r.d(n,{xA:()=>d,yg:()=>u});var a=r(6540);function t(e,n,r){return n in e?Object.defineProperty(e,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[n]=r,e}function i(e,n){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),r.push.apply(r,a)}return r}function l(e){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{};n%2?i(Object(r),!0).forEach(function(n){t(e,n,r[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):i(Object(r)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(r,n))})}return e}function o(e,n){if(null==e)return{};var r,a,t=function(e,n){if(null==e)return{};var r,a,t={},i=Object.keys(e);for(a=0;a<i.length;a++)r=i[a],n.indexOf(r)>=0||(t[r]=e[r]);return t}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)r=i[a],n.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(t[r]=e[r])}return t}var p=a.createContext({}),c=function(e){var n=a.useContext(p),r=n;return e&&(r="function"==typeof e?e(n):l(l({},n),e)),r},d=function(e){var n=c(e.components);return a.createElement(p.Provider,{value:n},e.children)},s="mdxType",_={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},g=a.forwardRef(function(e,n){var r=e.components,t=e.mdxType,i=e.originalType,p=e.parentName,d=o(e,["components","mdxType","originalType","parentName"]),s=c(r),g=t,u=s["".concat(p,".").concat(g)]||s[g]||_[g]||i;return r?a.createElement(u,l(l({ref:n},d),{},{components:r})):a.createElement(u,l({ref:n},d))});function u(e,n){var r=arguments,t=n&&n.mdxType;if("string"==typeof e||t){var i=r.length,l=new Array(i);l[0]=g;var o={};for(var p in n)hasOwnProperty.call(n,p)&&(o[p]=n[p]);o.originalType=e,o[s]="string"==typeof e?e:t,l[1]=o;for(var c=2;c<i;c++)l[c]=r[c];return a.createElement.apply(null,l)}return a.createElement.apply(null,r)}g.displayName="MDXCreateElement"}}]);
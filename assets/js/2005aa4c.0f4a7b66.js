"use strict";(globalThis.webpackChunkdocs_roll=globalThis.webpackChunkdocs_roll||[]).push([[1349],{28453:(e,n,t)=>{t.d(n,{R:()=>s,x:()=>a});var o=t(96540);const r={},i=o.createContext(r);function s(e){const n=o.useContext(i);return o.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:s(e.components),o.createElement(i.Provider,{value:n},e.children)}},50174:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>d,frontMatter:()=>s,metadata:()=>o,toc:()=>c});const o=JSON.parse('{"id":"Development/Developer Guide/prompt_intro","title":"Prompt Generation Guide","description":"In the architecture of Large Language Model (LLM)-based Reinforcement Learning Agents, the Prompt serves as the sole medium for LLMs to interact with the environment. Unlike traditional agents that directly receive numerical states or output discrete action IDs, LLMs \\"perceive\\" the environment (observations) and \\"express\\" their decisions (actions) through prompts in text format.","source":"@site/docs/Development/Developer Guide/prompt_intro.md","sourceDirName":"Development/Developer Guide","slug":"/Development/Developer Guide/prompt_intro","permalink":"/ROLL/docs/Development/Developer Guide/prompt_intro","draft":false,"unlisted":false,"editUrl":"https://github.com/alibaba/ROLL/tree/main/docs_roll/docs/Development/Developer Guide/prompt_intro.md","tags":[],"version":"current","lastUpdatedAt":1764905933000,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Customer Env","permalink":"/ROLL/docs/Development/Developer Guide/customer_env"}}');var r=t(74848),i=t(28453);const s={},a="Prompt Generation Guide",l={},c=[{value:"Core Concepts",id:"core-concepts",level:2},{value:"Prompt Generation Steps and Rules",id:"prompt-generation-steps-and-rules",level:2},{value:"Step 1: Initialization Conversation and Basic Instructions",id:"step-1-initialization-conversation-and-basic-instructions",level:3},{value:"Sokoban Example: Generating the First User Prompt",id:"sokoban-example-generating-the-first-user-prompt",level:4},{value:"Step 2: Iterate Through Environment History to Build Multi-turn Conversation Context",id:"step-2-iterate-through-environment-history-to-build-multi-turn-conversation-context",level:3},{value:"Sokoban Example: Multi-turn Prompt Construction",id:"sokoban-example-multi-turn-prompt-construction",level:4},{value:"Step 3: Apply Chat Template and Finally Generate Prompt Text",id:"step-3-apply-chat-template-and-finally-generate-prompt-text",level:3},{value:"Completed Prompt Generation Process",id:"completed-prompt-generation-process",level:2}];function h(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"prompt-generation-guide",children:"Prompt Generation Guide"})}),"\n",(0,r.jsxs)(n.p,{children:["In the architecture of Large Language Model (LLM)-based Reinforcement Learning Agents, the ",(0,r.jsx)(n.code,{children:"Prompt"}),' serves as the sole medium for LLMs to interact with the environment. Unlike traditional agents that directly receive numerical states or output discrete action IDs, LLMs "perceive" the environment (observations) and "express" their decisions (actions) through prompts in text format.']}),"\n",(0,r.jsx)(n.h2,{id:"core-concepts",children:"Core Concepts"}),"\n",(0,r.jsx)(n.p,{children:"In our framework, the generation of prompts adheres to several key principles:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"LLM Input is Text: Whether the environment's original observation is an image, a grid, or another structure, it will ultimately be converted into a text format that LLMs can understand."}),"\n",(0,r.jsx)(n.li,{children:"Prompts are Dynamic and Contextual: A prompt is not merely the current environmental observation; it also includes historical dialogue, previous actions, received rewards, and other information, forming a coherent conversational context."}),"\n",(0,r.jsx)(n.li,{children:"Prompts are Structured Conversational Formats: Prompts typically follow the LLM's chat template (e.g., System/User/Assistant roles) to help the LLM better understand the intent of different parts."}),"\n",(0,r.jsx)(n.li,{children:"Prompts can guide LLM's behavior: Through precise instructions, output format requirements, and Chain-of-Thought (CoT) prompting, prompts can guide the LLM to generate responses in the expected style."}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["The generation of prompts is primarily managed by the ",(0,r.jsx)(n.code,{children:"_format_messages"})," method within the ",(0,r.jsx)(n.code,{children:"EnvManager"})," class."]}),"\n",(0,r.jsx)(n.h2,{id:"prompt-generation-steps-and-rules",children:"Prompt Generation Steps and Rules"}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"_format_messages"})," method is the core of prompt generation. It receives ",(0,r.jsx)(n.code,{children:"env_output"})," (containing current observations and historical information) and transforms it into LLM input based on a series of rules."]}),"\n",(0,r.jsx)(n.h3,{id:"step-1-initialization-conversation-and-basic-instructions",children:"Step 1: Initialization Conversation and Basic Instructions"}),"\n",(0,r.jsx)(n.p,{children:"Prompt generation begins by constructing the skeleton of a conversation, including system instructions and the first user instruction."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'messages = [\n    # System Prompt: Defines the role and goal of the LLM\n    {"role": "system", "content": "You\'re a helpful assistant. You are a good game player. You are aiming to get high reward in the game."},\n    # First User Prompt: Contains the overall introduction to the environment and initial instructions\n    {"role": "user", "content": first_user_content}\n]\n'})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"System Prompt"}),': This is a fixed instruction used to set the LLM\'s general role ("helpful assistant," "good game player") and overall goal ("aiming to get high reward"), which provides the LLM with a global guiding principle for action.']}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"First User Prompt"})," (",(0,r.jsx)(n.code,{children:"first_user_content"}),"): This is the most critical initialization part, which introduces the environment's rules, symbol meanings, available actions, and response format. Its content is pre-generated by the\xa0",(0,r.jsx)(n.code,{children:"EnvManager._init_prefix_lookup"}),"\xa0method, combining\xa0",(0,r.jsx)(n.code,{children:"env_instruction"}),",\xa0",(0,r.jsx)(n.code,{children:"grid_vocab"}),",\xa0",(0,r.jsx)(n.code,{children:"action_lookup"})," from the environment configuration."]}),"\n"]}),"\n",(0,r.jsx)(n.h4,{id:"sokoban-example-generating-the-first-user-prompt",children:"Sokoban Example: Generating the First User Prompt"}),"\n",(0,r.jsxs)(n.p,{children:["Assume the\xa0",(0,r.jsx)(n.code,{children:"SokobanEnvConfig"}),"\xa0is configured as follows:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'env_instruction: "You are solving the Sokoban puzzle. You are the player and you need to push all boxes to targets. When you are right next to a box, you can push it by moving in the same direction. You cannot push a box through a wall, and you cannot pull a box. The answer must be one of action in a turn, format is <answer>Right</answer>"\n\ngrid_vocab:\n  "#": "wall"\n  "_": "empty"\n  "O": "target"\n  "\u221a": "box on target"\n  "X": "box"\n  "P": "player"\n  "S": "player on target"\n\naction_lookup:\n  1: "Up"\n  2: "Down"\n  3: "Left"\n  4: "Right"\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Then, ",(0,r.jsx)(n.code,{children:"first_user_content"})," (i.e., the first User Prompt) will be constructed as a string similar to the following:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"You are solving the Sokoban puzzle. You are the player and you need to push all boxes to targets. When you are right next to a box, you can push it by moving in the same direction. You cannot push a box through a wall, and you cannot pull a box. The answer must be one of action in a turn, format is <answer>Right</answer>\n\nThe meaning of each symbol in the state is:\n#: wall, _: empty, O: target, \u221a: box on target, X: box, P: player, S: player on target\n\nYour available actions are:\nUp, Down, Left, Right\n"})}),"\n",(0,r.jsx)(n.p,{children:"This Prompt block comprehensively describes the rules of the Sokoban game, the meaning of visual symbols, and the executable actions to the LLM, providing a foundational understanding for subsequent decision-making."}),"\n",(0,r.jsx)(n.h3,{id:"step-2-iterate-through-environment-history-to-build-multi-turn-conversation-context",children:"Step 2: Iterate Through Environment History to Build Multi-turn Conversation Context"}),"\n",(0,r.jsxs)(n.p,{children:["After the initial Prompt, ",(0,r.jsx)(n.code,{children:"_format_messages"})," will iterate through ",(0,r.jsx)(n.code,{children:"env_output['history']"}),", adding observations, LLM responses, and rewards from each previous step to the conversation, forming a continuous context."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'# Iterate through environment history to build multi-turn conversation Prompt\nfor idx, content in enumerate(env_output["history"]):\n    # 1. Add turn number\n    messages[-1]["content"] += f"\\nTurn {idx + 1}:\\n"\n\n    # 2. Process environment state\n    if "state" in content:\n        FORMAT_PROMPT = "<think> [Your thoughts] </think> <answer> [your answer] </answer>" if self.pipeline_config.enable_think else "<answer> [your answer] </answer>"\n        LENGTH_PROMPT = f"Max response length: {self.env_config_lookup[env_output[\'env_id\']][\'max_tokens\']} words (tokens)."\n        messages[-1]["content"] += (\n            f"State:\\n{content[\'state\']}\\n"\n            f"You have {content[\'actions_left\']} actions left. "\n            f"Always output: {FORMAT_PROMPT} with no extra text."\n            f"Strictly follow this format, history response that do not follow the format will be set as \'INVALID\'. {LENGTH_PROMPT}\\n"\n            f"Decide the next action:\\n"\n        )\n    \n    # 3. Process LLM\'s response\n    if "llm_raw_response" in content:\n        messages.append({"role": "assistant", "content": content["llm_response"]})\n\n    # 4. Process reward\n    if "reward" in content:\n        messages.append({"role": "user", "content": f"Reward:\\n{content[\'reward\']}\\n"})\n'})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Turn Number: ",(0,r.jsx)(n.code,{children:"\\nTurn {idx + 1}:\\n"}),"\xa0explicitly labels the current turn of the conversation, helping the LLM understand the temporal sequence."]}),"\n",(0,r.jsx)(n.li,{children:"Environment State: The environmental observation for the current turn. For Sokoban, this is the grid layout in text form."}),"\n",(0,r.jsxs)(n.li,{children:["Actions Remaining: ",(0,r.jsx)(n.code,{children:"You have {content['actions_left']} actions left"})," informs the LLM about the action limits for the current turn, aiding long-term planning."]}),"\n",(0,r.jsxs)(n.li,{children:["Forced Output Format\uff1aUsually includes [Your thoughts] [your answer] (if ",(0,r.jsx)(n.code,{children:"enable_think"})," = true) or [your answer], which compels the LLM to return its thoughts and final action in a structured style."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"LENGTH_PROMPT"}),": Hints at the maximum length for the LLM's response."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"Strictly follow this format..."}),": Emphasizes the importance of the format and warns that non-conforming responses will be marked as 'INVALID'."]}),"\n",(0,r.jsxs)(n.li,{children:["LLM Response (",(0,r.jsx)(n.code,{children:"Assistant"})," role): The action generated by the LLM in the previous turn is added to the history as an Assistant message."]}),"\n",(0,r.jsxs)(n.li,{children:["Reward (",(0,r.jsx)(n.code,{children:"User"})," role): The reward feedback from the environment for the LLM's previous action is added to the history as a User message, providing an RL signal."]}),"\n"]}),"\n",(0,r.jsx)(n.h4,{id:"sokoban-example-multi-turn-prompt-construction",children:"Sokoban Example: Multi-turn Prompt Construction"}),"\n",(0,r.jsx)(n.p,{children:"Assume the initial state of the environment is:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"#####\n#__O#  <- Target O\n#P_X#  <- Player P, Box X\n#___#\n#####\n"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Turn 1 (LLM receives Prompt for the first time)"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["Before the LLM generates its first action, the Prompt it receives might look like this (simplified format, actual conversion uses ",(0,r.jsx)(n.code,{children:"apply_chat_template"}),"):"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"<|im_start|>system\nYou're a helpful assistant. You are a good game player. You are aiming to get high reward in the game.<|im_end|>\n<|im_start|>user\nYou are solving the Sokoban puzzle. You are the player and you need to push all boxes to targets. When you are right next to a box, you can push it by moving in the same direction. You cannot push a box through a wall, and you cannot pull a box. The answer must be one of action in a turn, format is <answer>Right</answer>\n\nThe meaning of each symbol in the state is:\n#: wall, _: empty, O: target, \u221a: box on target, X: box, P: player, S: player on target\n\nYour available actions are:\nUp, Down, Left, Right\n\nTurn 1:\nState:\n#####\n#__O#  \n#P_X#  \n#___#\n#####\nYou have 100 actions left. Always output: <answer> [your answer] </answer> with no extra text. Strictly follow this format, history response that do not follow the format will be set as 'INVALID'. Max response length: 100 words (tokens).\nDecide the next action:<|im_end|>\n<|im_start|>assistant\n"})}),"\n",(0,r.jsxs)(n.p,{children:["The LLM might generate ",(0,r.jsx)(n.code,{children:"<answer>Right</answer>"})]}),"\n",(0,r.jsxs)(n.ol,{start:"2",children:["\n",(0,r.jsx)(n.li,{children:"Turn 2 (LLM receives new state and reward)"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Assume the LLM chose Right. After the environment responds, the box is pushed one cell to the right, and the reward is -0.1. The new state is:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"#####\n#__O#\n#_PX#\n#___#\n#####\n"})}),"\n",(0,r.jsx)(n.p,{children:"At this point, the LLM will receive a Prompt containing all interactions from the first turn:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"<|im_start|>system\nYou're a helpful assistant. You are a good game player. You are aiming to get high reward in the game.<|im_end|>\n<|im_start|>user\nYou are solving the Sokoban puzzle. You are the player and you need to push all boxes to targets. When you are right next to a box, you can push it by moving in the same direction. You cannot push a box through a wall, and you cannot pull a box. The answer must be one of action in a turn, format is <answer>Right</answer>\n\nThe meaning of each symbol in the state is:\n#: wall, _: empty, O: target, \u221a: box on target, X: box, P: player, S: player on target\n\nYour available actions are:\nUp, Down, Left, Right\n\nTurn 1:\nState:\n#####\n#__O#  \n#P_X#  \n#___#\n#####\nYou have 100 actions left. Always output: <answer> [your answer] </answer> with no extra text. Strictly follow this format, history response that do not follow the format will be set as 'INVALID'. Max response length: 100 words (tokens).\nDecide the next action:<|im_end|>\n<|im_start|>assistant\n<answer>Right</answer><|im_end|>\n<|im_start|>user\nReward:\n-0.1\n<|im_end|>\n<|im_start|>user\nTurn 2:\nState:\n#####\n#__O#\n#_PX#\n#___#\n#####\nYou have 99 actions left. Always output: <answer> [your answer] </answer> with no extra text. Strictly follow this format, history response that do not follow the format will be set as 'INVALID'. Max response length: 100 words (tokens).\nDecide the next action:<|im_end|>\n<|im_start|>assistant\n"})}),"\n",(0,r.jsx)(n.p,{children:"In this way, the LLM can see the completed conversation history each time, including its own decisions and the feedback from the environment, which is crucial for learning and long-term planning."}),"\n",(0,r.jsx)(n.h3,{id:"step-3-apply-chat-template-and-finally-generate-prompt-text",children:"Step 3: Apply Chat Template and Finally Generate Prompt Text"}),"\n",(0,r.jsx)(n.p,{children:"The final step is to convert the constructed messages list into a single string format of the Prompt that the LLM actually accepts."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'# Apply chat template to generate final Prompt text\nif self.processor: # For multi-modal models using ProcessorMixin\n    text = self.processor.apply_chat_template(messages, add_generation_prompt=(not prepare_for_update), tokenize=False)\nelse: # For text-only models using PreTrainedTokenizer\n    text = self.tokenizer.apply_chat_template(messages, add_generation_prompt=(not prepare_for_update), tokenize=False)\n\n# Force LLM to generate specific starting token (in inference mode)\nif not prepare_for_update:\n    if self.pipeline_config.enable_think:\n        text += "<think>" # Force LLM to think before answering\n    else:\n        text += "<answer>" # Force LLM to answer\n\n# Clean up special tokens\ntext = text.replace("<|im_end|>\\n", "<|im_end|>")\n'})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"apply_chat_template"}),"\uff1aThis is a method provided by the Hugging Face transformers library. It converts the messages list into a flattened string according to the specific format of the LLM being used (e.g., Qwen's ",(0,r.jsx)(n.code,{children:"<|im_start|>role\\ncontent<|im_end|>"})," structure)."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"add_generation_prompt"}),"\uff1aIn inference mode (not prepare_for_update), this parameter typically adds a special token to the end of the Prompt, such as ",(0,r.jsx)(n.code,{children:"<|im_start|>assistant\\n"}),", explicitly telling the LLM that it is now its turn to generate as the assistant role."]}),"\n",(0,r.jsxs)(n.li,{children:["Force the Generation of Starting Token: When the LLM performs inference (generates a response), to ensure its output strictly follow the predefined format, we add a specific starting token, such as ",(0,r.jsx)(n.code,{children:"<think>"})," or ",(0,r.jsx)(n.code,{children:"<answer>"}),', to the end of the Prompt. This is a technique known as "Prompt Injection" or "Conditional Generation."',"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Guide LLM to Continue: The essence of an LLM is to predict the next most probable token in a given sequence. When we place a marker like ",(0,r.jsx)(n.code,{children:"<answer>"})," at the end of the Prompt, the LLM treats it as an incomplete sequence and naturally attempts to continue generating content after this marker."]}),"\n",(0,r.jsxs)(n.li,{children:["Enforce Format Adherence: If the Prompt has clearly specified that the response must be in the format ",(0,r.jsx)(n.code,{children:"<answer>[your answer]</answer>"}),", then by placing ",(0,r.jsx)(n.code,{children:"</answer>"}),' at the end of the Prompt, we are effectively pre-filling a part of the response format. Upon receiving this incomplete format, the LLM is "forced" to generate ',(0,r.jsx)(n.code,{children:"[your answer]"})," part and ultimately complete the ",(0,r.jsx)(n.code,{children:"</answer>"})," tag\u3002"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"completed-prompt-generation-process",children:"Completed Prompt Generation Process"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Environment Configuration"}),"\uff08",(0,r.jsx)(n.code,{children:"SokobanEnvConfig"}),"\uff09: Defines the static information of the environment (instructions, symbol meanings, action names)."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"_init_prefix_lookup"}),": During ",(0,r.jsx)(n.code,{children:"EnvManager"})," initialization, combines the static information from the environment configuration into ",(0,r.jsx)(n.code,{children:"first_user_content"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"_format_messages"}),"\uff1a\na. Called when starting a new turn or receiving new environmental feedback.\nb. Use ",(0,r.jsx)(n.code,{children:"System Prompt"})," and ",(0,r.jsx)(n.code,{children:"first_user_content"})," as the beginning of the conversation.\nc. Iterates through ",(0,r.jsx)(n.code,{children:"env_output['history']"}),", successively adding turn numbers, environmental states, remaining actions, historical LLM responses, rewards, and other dynamic information.\nd. Repeats mandatory format requirements after the environmental state in each turn.\ne. Use ",(0,r.jsx)(n.code,{children:"tokenizer.apply_chat_template"}),"  to convert the constructed structured ",(0,r.jsx)(n.code,{children:"messages"})," list into the final Prompt string acceptable by the LLM.\nf. In inference mode, add the forced generation starting token ",(0,r.jsx)(n.code,{children:"<think>"})," or ",(0,r.jsx)(n.code,{children:"<answer>"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"LLM Receives the Prompt"}),"\uff1aReceives this carefully constructed Prompt string, performs inference, and generates a response."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Through this layered, structured, and dynamic Prompt generation mechanism, our framework effectively combines complex environments with the powerful language capabilities of LLMs, enabling them to understand tasks, perceive environments, learn rules, and execute complex operations."})]})}function d(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(h,{...e})}):h(e)}}}]);
"use strict";(globalThis.webpackChunkdocs_roll=globalThis.webpackChunkdocs_roll||[]).push([[8251],{1485:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>o,contentTitle:()=>i,default:()=>y,frontMatter:()=>r,metadata:()=>p,toc:()=>g});var l=a(8168),t=(a(6540),a(5680));const r={},i="Off-Policy \u7b97\u6cd5\u914d\u7f6e\u6307\u5357",p={unversionedId:"\u7b80\u4f53\u4e2d\u6587/\u4f7f\u7528\u6307\u5357/algorithms/offpolicy_setting",id:"\u7b80\u4f53\u4e2d\u6587/\u4f7f\u7528\u6307\u5357/algorithms/offpolicy_setting",title:"Off-Policy \u7b97\u6cd5\u914d\u7f6e\u6307\u5357",description:"ROLL \u6846\u67b6\u652f\u6301\u591a\u79cd Off-Policy \u7b97\u6cd5\u53d8\u4f53\uff0c\u7528\u4e8easync-training\u3002\u672c\u6587\u6863\u8be6\u7ec6\u4ecb\u7ecd\u5404\u79cd\u7b97\u6cd5\u7684\u914d\u7f6e\u65b9\u6cd5\u548c\u4f7f\u7528\u793a\u4f8b\u3002",source:"@site/docs/\u7b80\u4f53\u4e2d\u6587/\u4f7f\u7528\u6307\u5357/algorithms/offpolicy_setting.md",sourceDirName:"\u7b80\u4f53\u4e2d\u6587/\u4f7f\u7528\u6307\u5357/algorithms",slug:"/\u7b80\u4f53\u4e2d\u6587/\u4f7f\u7528\u6307\u5357/algorithms/offpolicy_setting",permalink:"/ROLL/docs/\u7b80\u4f53\u4e2d\u6587/\u4f7f\u7528\u6307\u5357/algorithms/offpolicy_setting",draft:!1,editUrl:"https://github.com/alibaba/ROLL/tree/main/docs_roll/docs/\u7b80\u4f53\u4e2d\u6587/\u4f7f\u7528\u6307\u5357/algorithms/offpolicy_setting.md",tags:[],version:"current",lastUpdatedAt:1761894972,formattedLastUpdatedAt:"Oct 31, 2025",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"TOPR (Tapered Off-Policy REINFORCE)",permalink:"/ROLL/docs/\u7b80\u4f53\u4e2d\u6587/\u4f7f\u7528\u6307\u5357/algorithms/TOPR"},next:{title:"RL options \u5927\u5168",permalink:"/ROLL/docs/\u7b80\u4f53\u4e2d\u6587/\u4f7f\u7528\u6307\u5357/algorithms/rl_options"}},o={},g=[{value:"\u652f\u6301\u7684\u7b97\u6cd5\u53d8\u4f53",id:"\u652f\u6301\u7684\u7b97\u6cd5\u53d8\u4f53",level:2},{value:"\u57fa\u7840\u914d\u7f6e",id:"\u57fa\u7840\u914d\u7f6e",level:2},{value:"\u6838\u5fc3\u53c2\u6570",id:"\u6838\u5fc3\u53c2\u6570",level:3},{value:"Worker \u914d\u7f6e",id:"worker-\u914d\u7f6e",level:3},{value:"\u5404\u7b97\u6cd5\u8be6\u7ec6\u914d\u7f6e",id:"\u5404\u7b97\u6cd5\u8be6\u7ec6\u914d\u7f6e",level:2},{value:"1. Vanilla Policy Gradient",id:"1-vanilla-policy-gradient",level:3},{value:"2. PPO (Proximal Policy Optimization)",id:"2-ppo-proximal-policy-optimization",level:3},{value:"3. TIS (Truncated Importance Sampling)",id:"3-tis-truncated-importance-sampling",level:3},{value:"4. TOPR (Tapered off-policy REINFORCE)",id:"4-topr-tapered-off-policy-reinforce",level:3},{value:"5. CISPO (Clipped Importance Sampling Policy Optimization)",id:"5-cispo-clipped-importance-sampling-policy-optimization",level:3},{value:"6. Kimi15",id:"6-kimi15",level:3},{value:"\u5b8c\u6574\u914d\u7f6e\u793a\u4f8b",id:"\u5b8c\u6574\u914d\u7f6e\u793a\u4f8b",level:2}],c={toc:g},s="wrapper";function y({components:e,...n}){return(0,t.yg)(s,(0,l.A)({},c,n,{components:e,mdxType:"MDXLayout"}),(0,t.yg)("h1",{id:"off-policy-\u7b97\u6cd5\u914d\u7f6e\u6307\u5357"},"Off-Policy \u7b97\u6cd5\u914d\u7f6e\u6307\u5357"),(0,t.yg)("p",null,"ROLL \u6846\u67b6\u652f\u6301\u591a\u79cd Off-Policy \u7b97\u6cd5\u53d8\u4f53\uff0c\u7528\u4e8easync-training\u3002\u672c\u6587\u6863\u8be6\u7ec6\u4ecb\u7ecd\u5404\u79cd\u7b97\u6cd5\u7684\u914d\u7f6e\u65b9\u6cd5\u548c\u4f7f\u7528\u793a\u4f8b\u3002"),(0,t.yg)("h2",{id:"\u652f\u6301\u7684\u7b97\u6cd5\u53d8\u4f53"},"\u652f\u6301\u7684\u7b97\u6cd5\u53d8\u4f53"),(0,t.yg)("p",null,"ROLL \u6846\u67b6\u76ee\u524d\u652f\u6301\u4ee5\u4e0b Off-Policy \u7b97\u6cd5\uff1a"),(0,t.yg)("ol",null,(0,t.yg)("li",{parentName:"ol"},(0,t.yg)("strong",{parentName:"li"},"vanilla")," - \u57fa\u7840 Policy Gradient \u7b97\u6cd5"),(0,t.yg)("li",{parentName:"ol"},(0,t.yg)("strong",{parentName:"li"},"ppo")," - Proximal Policy Optimization"),(0,t.yg)("li",{parentName:"ol"},(0,t.yg)("strong",{parentName:"li"},"tis")," - Truncated Importance Sampling"),(0,t.yg)("li",{parentName:"ol"},(0,t.yg)("strong",{parentName:"li"},"topr")," - Tapered off-policy REINFORCE"),(0,t.yg)("li",{parentName:"ol"},(0,t.yg)("strong",{parentName:"li"},"cispo")," - Clipped Importance Sampling Policy Optimization"),(0,t.yg)("li",{parentName:"ol"},(0,t.yg)("strong",{parentName:"li"},"kimi15")," - Kimi15 \u7b97\u6cd5")),(0,t.yg)("h2",{id:"\u57fa\u7840\u914d\u7f6e"},"\u57fa\u7840\u914d\u7f6e"),(0,t.yg)("h3",{id:"\u6838\u5fc3\u53c2\u6570"},"\u6838\u5fc3\u53c2\u6570"),(0,t.yg)("p",null,"\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u8bbe\u7f6e Off-Policy \u7b97\u6cd5\u7684\u57fa\u672c\u53c2\u6570\uff1a"),(0,t.yg)("pre",null,(0,t.yg)("code",{parentName:"pre",className:"language-yaml"},'# \u9009\u62e9\u7b97\u6cd5\u53d8\u4f53\npg_variant: topr  # \u53ef\u9009: vanilla, tis, topr, cispo, kimi15, ppo\n\n# \u8bad\u7ec3\u914d\u7f6e\nmax_steps: 500\nsave_steps: 100\nlogging_steps: 1\neval_steps: 10\n\n# \u6570\u636e\u914d\u7f6e\nrollout_batch_size: 128\nprompt_length: 2048\nresponse_length: 8192\nnum_return_sequences_in_group: 8\n\n# \u901a\u7528\u8bad\u7ec3\u53c2\u6570\nppo_epochs: 1\nadv_estimator: "reinforce"\nwhiten_advantages: true\n')),(0,t.yg)("h3",{id:"worker-\u914d\u7f6e"},"Worker \u914d\u7f6e"),(0,t.yg)("p",null,"\u4f7f\u7528\u4e13\u95e8\u7684 ActorPGWorker \u6765\u5904\u7406 Off-Policy \u7b97\u6cd5\uff1a"),(0,t.yg)("pre",null,(0,t.yg)("code",{parentName:"pre",className:"language-yaml"},"actor_train:\n  worker_cls: roll.pipeline.rlvr.actor_pg_worker.ActorPGWorker\n  pg_variant: topr  # \u4e0e\u5168\u5c40\u914d\u7f6e\u4fdd\u6301\u4e00\u81f4\n  model_args:\n    flash_attn: fa2\n    disable_gradient_checkpointing: false\n    dtype: bf16\n  training_args:\n    learning_rate: 1.0e-6\n    weight_decay: 0\n    per_device_train_batch_size: 1\n    gradient_accumulation_steps: 64\n    warmup_steps: 20\n    num_train_epochs: 50\n  strategy_args:\n    strategy_name: megatron_train\n    strategy_config:\n      tensor_model_parallel_size: 1\n      pipeline_model_parallel_size: 1\n      use_distributed_optimizer: true\n      recompute_granularity: full\n  device_mapping: list(range(0,16))\n")),(0,t.yg)("h2",{id:"\u5404\u7b97\u6cd5\u8be6\u7ec6\u914d\u7f6e"},"\u5404\u7b97\u6cd5\u8be6\u7ec6\u914d\u7f6e"),(0,t.yg)("h3",{id:"1-vanilla-policy-gradient"},"1. Vanilla Policy Gradient"),(0,t.yg)("p",null,"\u6700\u57fa\u7840\u7684\u7b56\u7565\u68af\u5ea6\u7b97\u6cd5\uff0c\u76f4\u63a5\u4f7f\u7528 log \u6982\u7387\u548c\u4f18\u52bf\u51fd\u6570\u7684\u4e58\u79ef\u4f5c\u4e3a\u635f\u5931\u3002"),(0,t.yg)("p",null,(0,t.yg)("strong",{parentName:"p"},"\u914d\u7f6e\u7279\u70b9\uff1a")),(0,t.yg)("ul",null,(0,t.yg)("li",{parentName:"ul"},"\u65e0\u9700\u989d\u5916\u53c2\u6570"),(0,t.yg)("li",{parentName:"ul"},"\u8ba1\u7b97\u6548\u7387\u9ad8"),(0,t.yg)("li",{parentName:"ul"},"\u9002\u5408\u7b80\u5355\u7684\u5f3a\u5316\u5b66\u4e60\u4efb\u52a1")),(0,t.yg)("pre",null,(0,t.yg)("code",{parentName:"pre",className:"language-yaml"},"pg_variant: vanilla\n\n# \u65e0\u9700\u989d\u5916\u914d\u7f6e\u53c2\u6570\n")),(0,t.yg)("h3",{id:"2-ppo-proximal-policy-optimization"},"2. PPO (Proximal Policy Optimization)"),(0,t.yg)("p",null,"\u8fd1\u7aef\u7b56\u7565\u4f18\u5316\u7b97\u6cd5\uff0c\u901a\u8fc7\u88c1\u526a\u91cd\u8981\u6027\u91c7\u6837\u6bd4\u7387\u6765\u7a33\u5b9a\u8bad\u7ec3\u3002"),(0,t.yg)("p",null,(0,t.yg)("strong",{parentName:"p"},"\u5173\u952e\u53c2\u6570\uff1a")),(0,t.yg)("pre",null,(0,t.yg)("code",{parentName:"pre",className:"language-yaml"},"pg_variant: ppo\n\n# PPO \u7279\u5b9a\u53c2\u6570\npg_clip: 0.2                    # \u88c1\u526a\u8303\u56f4\npg_clip_low: 0.2               # \u4e0b\u754c\u88c1\u526a\uff08\u53ef\u9009\uff09\npg_clip_high: 0.2              # \u4e0a\u754c\u88c1\u526a\uff08\u53ef\u9009\uff09\nuse_pg_clip_range: false       # \u662f\u5426\u4f7f\u7528\u4e0d\u5bf9\u79f0\u88c1\u526a\ndual_clip_loss: true           # \u662f\u5426\u542f\u7528\u53cc\u91cd\u88c1\u526a\n")),(0,t.yg)("p",null,(0,t.yg)("strong",{parentName:"p"},"\u914d\u7f6e\u793a\u4f8b\uff1a")),(0,t.yg)("pre",null,(0,t.yg)("code",{parentName:"pre",className:"language-yaml"},"pg_variant: ppo\npg_clip: 0.2\ndual_clip_loss: true\n")),(0,t.yg)("h3",{id:"3-tis-truncated-importance-sampling"},"3. TIS (Truncated Importance Sampling)"),(0,t.yg)("p",null,"\u622a\u65ad\u91cd\u8981\u6027\u91c7\u6837\u7b97\u6cd5\uff0c\u5c06\u91cd\u8981\u6027\u91c7\u6837\u6bd4\u7387\u9650\u5236\u5728 ","[0, 1]"," \u8303\u56f4\u5185\u3002"),(0,t.yg)("p",null,(0,t.yg)("strong",{parentName:"p"},"\u5173\u952e\u53c2\u6570\uff1a")),(0,t.yg)("pre",null,(0,t.yg)("code",{parentName:"pre",className:"language-yaml"},"pg_variant: tis\n\n# TIS \u7279\u5b9a\u53c2\u6570\ntis_lower_bound: 0.0           # \u4e0b\u754c\ntis_upper_bound: 1.0           # \u4e0a\u754c\n")),(0,t.yg)("p",null,(0,t.yg)("strong",{parentName:"p"},"\u914d\u7f6e\u793a\u4f8b\uff1a")),(0,t.yg)("pre",null,(0,t.yg)("code",{parentName:"pre",className:"language-yaml"},"pg_variant: tis\ntis_lower_bound: 0.0\ntis_upper_bound: 1.0\n")),(0,t.yg)("h3",{id:"4-topr-tapered-off-policy-reinforce"},"4. TOPR (Tapered off-policy REINFORCE)"),(0,t.yg)("p",null,"\u9525\u5f62\u79bb\u7b56\u7565\u5f3a\u5316\u5b66\u4e60\u7b97\u6cd5\uff0c\u6839\u636e\u5956\u52b1\u7684\u6b63\u8d1f\u5206\u522b\u91c7\u7528\u4e0d\u540c\u7684\u66f4\u65b0\u7b56\u7565\u3002"),(0,t.yg)("p",null,(0,t.yg)("strong",{parentName:"p"},"\u7b97\u6cd5\u7279\u70b9\uff1a")),(0,t.yg)("ul",null,(0,t.yg)("li",{parentName:"ul"},"\u6b63\u6837\u672c\uff1a\u76f4\u63a5 SFT \u66f4\u65b0\uff0c\u4e0d\u4f7f\u7528\u91cd\u8981\u6027\u91c7\u6837"),(0,t.yg)("li",{parentName:"ul"},"\u8d1f\u6837\u672c\uff1a\u4f7f\u7528 TIS \u66f4\u65b0\uff0c\u9650\u5236\u91cd\u8981\u6027\u91c7\u6837\u6bd4\u7387\u5728 ","[0, 1]")),(0,t.yg)("p",null,(0,t.yg)("strong",{parentName:"p"},"\u5173\u952e\u53c2\u6570\uff1a")),(0,t.yg)("pre",null,(0,t.yg)("code",{parentName:"pre",className:"language-yaml"},"pg_variant: topr\n\n# TOPR \u7279\u5b9a\u53c2\u6570\ntopr_positive_weight: 1.0      # \u6b63\u6837\u672c\u6743\u91cd\ntopr_negative_weight: 1.0      # \u8d1f\u6837\u672c\u6743\u91cd\n")),(0,t.yg)("p",null,(0,t.yg)("strong",{parentName:"p"},"\u914d\u7f6e\u793a\u4f8b\uff1a")),(0,t.yg)("pre",null,(0,t.yg)("code",{parentName:"pre",className:"language-yaml"},"pg_variant: topr\ntopr_positive_weight: 1.0\ntopr_negative_weight: 1.0\n")),(0,t.yg)("h3",{id:"5-cispo-clipped-importance-sampling-policy-optimization"},"5. CISPO (Clipped Importance Sampling Policy Optimization)"),(0,t.yg)("p",null,"\u622a\u65ad\u91cd\u8981\u6027\u91c7\u6837\u7b56\u7565\u4f18\u5316\u7b97\u6cd5\uff0c\u4f7f\u7528\u622a\u65ad\u7684\u91cd\u8981\u6027\u91c7\u6837\u6743\u91cd\u548c stop-gradient \u64cd\u4f5c\u3002"),(0,t.yg)("p",null,(0,t.yg)("strong",{parentName:"p"},"\u5173\u952e\u53c2\u6570\uff1a")),(0,t.yg)("pre",null,(0,t.yg)("code",{parentName:"pre",className:"language-yaml"},"pg_variant: cispo\n\n# CISPO \u7279\u5b9a\u53c2\u6570\ncispo_epsilon_low: 0.1         # \u4e0b\u754c\u88c1\u526a\u53c2\u6570\ncispo_epsilon_high: 0.1        # \u4e0a\u754c\u88c1\u526a\u53c2\u6570\ncispo_use_unified_mask: false  # \u662f\u5426\u4f7f\u7528\u7edf\u4e00\u63a9\u7801\n")),(0,t.yg)("p",null,(0,t.yg)("strong",{parentName:"p"},"\u914d\u7f6e\u793a\u4f8b\uff1a")),(0,t.yg)("pre",null,(0,t.yg)("code",{parentName:"pre",className:"language-yaml"},"pg_variant: cispo\ncispo_epsilon_low: 0.1\ncispo_epsilon_high: 0.1\ncispo_use_unified_mask: false\n")),(0,t.yg)("h3",{id:"6-kimi15"},"6. Kimi15"),(0,t.yg)("p",null,"\u57fa\u4e8e KL \u6b63\u5219\u5316\u7684\u7b56\u7565\u68af\u5ea6\u7b97\u6cd5\uff0c\u5728\u7b56\u7565\u68af\u5ea6\u9879\u4e2d\u52a0\u5165 KL \u6563\u5ea6\u6b63\u5219\u5316\u9879\u3002"),(0,t.yg)("p",null,(0,t.yg)("strong",{parentName:"p"},"\u5173\u952e\u53c2\u6570\uff1a")),(0,t.yg)("pre",null,(0,t.yg)("code",{parentName:"pre",className:"language-yaml"},"pg_variant: kimi15\n\n# Kimi15 \u7279\u5b9a\u53c2\u6570\nkimi15_tau: 0.1               # \u6b63\u5219\u5316\u53c2\u6570\n")),(0,t.yg)("p",null,(0,t.yg)("strong",{parentName:"p"},"\u914d\u7f6e\u793a\u4f8b\uff1a")),(0,t.yg)("pre",null,(0,t.yg)("code",{parentName:"pre",className:"language-yaml"},"pg_variant: kimi15\nkimi15_tau: 0.1\n")),(0,t.yg)("h2",{id:"\u5b8c\u6574\u914d\u7f6e\u793a\u4f8b"},"\u5b8c\u6574\u914d\u7f6e\u793a\u4f8b"),(0,t.yg)("p",null,"RLVR Off-Policy \u914d\u7f6e\u793a\u4f8b\u53c2\u8003: examples/qwen2.5-7B-rlvr-offpolicy/rlvr_config.yaml"))}y.isMDXComponent=!0},5680:(e,n,a)=>{a.d(n,{xA:()=>c,yg:()=>u});var l=a(6540);function t(e,n,a){return n in e?Object.defineProperty(e,n,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[n]=a,e}function r(e,n){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);n&&(l=l.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),a.push.apply(a,l)}return a}function i(e){for(var n=1;n<arguments.length;n++){var a=null!=arguments[n]?arguments[n]:{};n%2?r(Object(a),!0).forEach(function(n){t(e,n,a[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(a,n))})}return e}function p(e,n){if(null==e)return{};var a,l,t=function(e,n){if(null==e)return{};var a,l,t={},r=Object.keys(e);for(l=0;l<r.length;l++)a=r[l],n.indexOf(a)>=0||(t[a]=e[a]);return t}(e,n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(l=0;l<r.length;l++)a=r[l],n.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(t[a]=e[a])}return t}var o=l.createContext({}),g=function(e){var n=l.useContext(o),a=n;return e&&(a="function"==typeof e?e(n):i(i({},n),e)),a},c=function(e){var n=g(e.components);return l.createElement(o.Provider,{value:n},e.children)},s="mdxType",y={inlineCode:"code",wrapper:function(e){var n=e.children;return l.createElement(l.Fragment,{},n)}},m=l.forwardRef(function(e,n){var a=e.components,t=e.mdxType,r=e.originalType,o=e.parentName,c=p(e,["components","mdxType","originalType","parentName"]),s=g(a),m=t,u=s["".concat(o,".").concat(m)]||s[m]||y[m]||r;return a?l.createElement(u,i(i({ref:n},c),{},{components:a})):l.createElement(u,i({ref:n},c))});function u(e,n){var a=arguments,t=n&&n.mdxType;if("string"==typeof e||t){var r=a.length,i=new Array(r);i[0]=m;var p={};for(var o in n)hasOwnProperty.call(n,o)&&(p[o]=n[o]);p.originalType=e,p[s]="string"==typeof e?e:t,i[1]=p;for(var g=2;g<r;g++)i[g]=a[g];return l.createElement.apply(null,i)}return l.createElement.apply(null,a)}m.displayName="MDXCreateElement"}}]);
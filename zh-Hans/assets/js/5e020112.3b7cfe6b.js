"use strict";(globalThis.webpackChunkdocs_roll=globalThis.webpackChunkdocs_roll||[]).push([[1923],{28453:(e,n,i)=>{i.d(n,{R:()=>d,x:()=>l});var r=i(96540);const s={},c=r.createContext(s);function d(e){const n=r.useContext(c);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:d(e.components),r.createElement(c.Provider,{value:n},e.children)}},99330:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>t,contentTitle:()=>l,default:()=>_,frontMatter:()=>d,metadata:()=>r,toc:()=>a});const r=JSON.parse('{"id":"Getting Started/FAQ/qa_issues","title":"\u5e38\u89c1\u95ee\u9898\u89e3\u7b54 (Q&A)","description":"\u672c\u6587\u6863\u6574\u7406\u4e86\u4f7f\u7528 ROLL \u6846\u67b6\u65f6\u53ef\u80fd\u9047\u5230\u7684\u5e38\u89c1\u95ee\u9898\u53ca\u5176\u89e3\u51b3\u65b9\u6848\u3002","source":"@site/i18n/zh-Hans/docusaurus-plugin-content-docs/current/Getting Started/FAQ/qa_issues.md","sourceDirName":"Getting Started/FAQ","slug":"/Getting Started/FAQ/qa_issues","permalink":"/ROLL/zh-Hans/docs/Getting Started/FAQ/qa_issues","draft":false,"unlisted":false,"editUrl":"https://github.com/alibaba/ROLL/tree/main/docs_roll/docs/Getting Started/FAQ/qa_issues.md","tags":[],"version":"current","lastUpdatedAt":1764223793000,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"ROLL \u8c03\u8bd5\u6307\u5357","permalink":"/ROLL/zh-Hans/docs/Getting Started/Debugging Guide/debug_guide"},"next":{"title":"ROLL \u914d\u7f6e\u6307\u5357","permalink":"/ROLL/zh-Hans/docs/User Guides/Configuration/config_guide"}}');var s=i(74848),c=i(28453);const d={},l="\u5e38\u89c1\u95ee\u9898\u89e3\u7b54 (Q&A)",t={},a=[{value:"\u6a21\u578b\u8f6c\u6362\u76f8\u5173",id:"\u6a21\u578b\u8f6c\u6362\u76f8\u5173",level:2},{value:"Megatron \u6a21\u578b\u5982\u4f55\u8f6c\u6210 HF \u683c\u5f0f\uff1f",id:"megatron-\u6a21\u578b\u5982\u4f55\u8f6c\u6210-hf-\u683c\u5f0f",level:3},{value:"\u8d44\u6e90\u914d\u7f6e\u76f8\u5173",id:"\u8d44\u6e90\u914d\u7f6e\u76f8\u5173",level:2},{value:"\u4ec0\u4e48\u662f colocate\uff08\u5171\u7f6e\uff09\u6a21\u5f0f\uff1f",id:"\u4ec0\u4e48\u662f-colocate\u5171\u7f6e\u6a21\u5f0f",level:3},{value:"\u4ec0\u4e48\u662f\u5206\u79bb\u6a21\u5f0f\uff1f",id:"\u4ec0\u4e48\u662f\u5206\u79bb\u6a21\u5f0f",level:3},{value:"\u8bad\u7ec3\u53c2\u6570\u76f8\u5173",id:"\u8bad\u7ec3\u53c2\u6570\u76f8\u5173",level:2},{value:"<code>rollout_batch_size</code> \u548c <code>num_return_sequences_in_group</code> \u662f\u4ec0\u4e48\u610f\u601d\uff1f",id:"rollout_batch_size-\u548c-num_return_sequences_in_group-\u662f\u4ec0\u4e48\u610f\u601d",level:3},{value:"\u5982\u4f55\u8bbe\u7f6e <code>gradient_accumulation_steps</code> \u548c <code>per_device_train_batch_size</code>\uff1f",id:"\u5982\u4f55\u8bbe\u7f6e-gradient_accumulation_steps-\u548c-per_device_train_batch_size",level:3},{value:"\u5bf9\u4e8e DeepSpeed Backend\uff1a",id:"\u5bf9\u4e8e-deepspeed-backend",level:4},{value:"\u5bf9\u4e8e Megatron Backend\uff1a",id:"\u5bf9\u4e8e-megatron-backend",level:4},{value:"\u8c03\u8bd5\u4e0e\u6027\u80fd\u5206\u6790\u76f8\u5173",id:"\u8c03\u8bd5\u4e0e\u6027\u80fd\u5206\u6790\u76f8\u5173",level:2},{value:"\u5982\u4f55\u83b7\u53d6\u8bad\u7ec3\u7684 timeline\uff1f",id:"\u5982\u4f55\u83b7\u53d6\u8bad\u7ec3\u7684-timeline",level:3},{value:"\u5982\u4f55 debug \u4ee3\u7801\uff1f",id:"\u5982\u4f55-debug-\u4ee3\u7801",level:3},{value:"\u5e38\u89c1\u9519\u8bef\u53ca\u89e3\u51b3\u65b9\u6848",id:"\u5e38\u89c1\u9519\u8bef\u53ca\u89e3\u51b3\u65b9\u6848",level:2},{value:"\u9519\u8bef\uff1a<code>self.node2pg[node_rank] KeyError: 1</code>",id:"\u9519\u8befselfnode2pgnode_rank-keyerror-1",level:3},{value:"\u9519\u8bef\uff1a<code>assert self.lr_decay_steps &gt; 0</code>",id:"\u9519\u8befassert-selflr_decay_steps--0",level:3},{value:"\u9519\u8bef\uff1a<code>AssertionError: batch_size 32 &lt; chunks 64</code>",id:"\u9519\u8befassertionerror-batch_size-32--chunks-64",level:3},{value:"\u9519\u8bef\uff1a<code>TypeError: BackendCompilerFailed.__init__() missing 1 required positional argument</code>",id:"\u9519\u8beftypeerror-backendcompilerfailed__init__-missing-1-required-positional-argument",level:3}];function o(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,c.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"\u5e38\u89c1\u95ee\u9898\u89e3\u7b54-qa",children:"\u5e38\u89c1\u95ee\u9898\u89e3\u7b54 (Q&A)"})}),"\n",(0,s.jsx)(n.p,{children:"\u672c\u6587\u6863\u6574\u7406\u4e86\u4f7f\u7528 ROLL \u6846\u67b6\u65f6\u53ef\u80fd\u9047\u5230\u7684\u5e38\u89c1\u95ee\u9898\u53ca\u5176\u89e3\u51b3\u65b9\u6848\u3002"}),"\n",(0,s.jsx)(n.h2,{id:"\u6a21\u578b\u8f6c\u6362\u76f8\u5173",children:"\u6a21\u578b\u8f6c\u6362\u76f8\u5173"}),"\n",(0,s.jsx)(n.h3,{id:"megatron-\u6a21\u578b\u5982\u4f55\u8f6c\u6210-hf-\u683c\u5f0f",children:"Megatron \u6a21\u578b\u5982\u4f55\u8f6c\u6210 HF \u683c\u5f0f\uff1f"}),"\n",(0,s.jsx)(n.p,{children:"\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\u8fdb\u884c\u683c\u5f0f\u8f6c\u6362\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"python mcore_adapter/tools/convert.py --checkpoint_path path_to_megatron_model --output_path path_to_output_hf_model\n"})}),"\n",(0,s.jsx)(n.h2,{id:"\u8d44\u6e90\u914d\u7f6e\u76f8\u5173",children:"\u8d44\u6e90\u914d\u7f6e\u76f8\u5173"}),"\n",(0,s.jsx)(n.h3,{id:"\u4ec0\u4e48\u662f-colocate\u5171\u7f6e\u6a21\u5f0f",children:"\u4ec0\u4e48\u662f colocate\uff08\u5171\u7f6e\uff09\u6a21\u5f0f\uff1f"}),"\n",(0,s.jsxs)(n.p,{children:["\u5728\u5171\u7f6e\u6a21\u5f0f\u4e0b\uff0c\u591a\u4e2a\u89d2\u8272\uff08\u5982 ",(0,s.jsx)(n.code,{children:"actor_train"}),"\u3001",(0,s.jsx)(n.code,{children:"actor_infer"}),"\u3001",(0,s.jsx)(n.code,{children:"reference"}),"\uff09\u7684 ",(0,s.jsx)(n.code,{children:"device_mapping"})," \u53ef\u4ee5\u590d\u7528\u76f8\u540c\u7684 GPU \u8bbe\u5907\u3002\u4f8b\u5982\uff1a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"actor_train:\n  device_mapping: list(range(0,8))\nactor_infer:\n  device_mapping: list(range(0,8))\nreference:\n  device_mapping: list(range(0,8))\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u6846\u67b6\u5e95\u5c42\u901a\u8fc7\u8d44\u6e90\u7ba1\u7406\u673a\u5236\u4fdd\u8bc1\u4e86\u591a\u4e2a\u89d2\u8272\u95f4 GPU \u7684\u590d\u7528\uff0c\u63d0\u9ad8\u8d44\u6e90\u5229\u7528\u7387\u3002"}),"\n",(0,s.jsx)(n.h3,{id:"\u4ec0\u4e48\u662f\u5206\u79bb\u6a21\u5f0f",children:"\u4ec0\u4e48\u662f\u5206\u79bb\u6a21\u5f0f\uff1f"}),"\n",(0,s.jsxs)(n.p,{children:["\u5728\u5206\u79bb\u6a21\u5f0f\u4e0b\uff0c\u4e0d\u540c\u89d2\u8272\u7684 ",(0,s.jsx)(n.code,{children:"device_mapping"})," \u4e4b\u95f4\u6ca1\u6709\u4ea4\u96c6\uff0c\u6bcf\u4e2a\u89d2\u8272\u6301\u6709\u4e00\u7ec4\u72ec\u7acb\u7684 GPU \u8bbe\u5907\u8d44\u6e90\u3002\u4f8b\u5982\uff1a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"actor_train:\n  device_mapping: list(range(0,8))\nactor_infer:\n  device_mapping: list(range(8,16))\nreference:\n  device_mapping: list(range(16,24))\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u8fd9\u79cd\u65b9\u5f0f\u53ef\u4ee5\u907f\u514d\u89d2\u8272\u95f4\u7684\u8d44\u6e90\u7ade\u4e89\uff0c\u63d0\u9ad8\u7cfb\u7edf\u7a33\u5b9a\u6027\u3002"}),"\n",(0,s.jsx)(n.h2,{id:"\u8bad\u7ec3\u53c2\u6570\u76f8\u5173",children:"\u8bad\u7ec3\u53c2\u6570\u76f8\u5173"}),"\n",(0,s.jsxs)(n.h3,{id:"rollout_batch_size-\u548c-num_return_sequences_in_group-\u662f\u4ec0\u4e48\u610f\u601d",children:[(0,s.jsx)(n.code,{children:"rollout_batch_size"})," \u548c ",(0,s.jsx)(n.code,{children:"num_return_sequences_in_group"})," \u662f\u4ec0\u4e48\u610f\u601d\uff1f"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"rollout_batch_size"}),"\uff1a\u4e00\u4e2a batch \u4e2d\u7684 prompt \u6570\u91cf"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"num_return_sequences_in_group"}),"\uff1a\u9488\u5bf9\u6bcf\u6761 prompt \u7684\u91c7\u6837\u6570\uff0c\u5373 vLLM/SGLang \u63a8\u7406\u4e2d\u901a\u5e38\u610f\u4e49\u4e0a\u7684 n \u53c2\u6570"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["\u5b9e\u9645\u4e00\u4e2a batch \u5185\u7684\u6837\u672c\u6570 = ",(0,s.jsx)(n.code,{children:"rollout_batch_size"})," * ",(0,s.jsx)(n.code,{children:"num_return_sequences_in_group"})]}),"\n",(0,s.jsx)(n.p,{children:"\u5bf9\u4e8e Megatron Backend\uff0c\u9700\u8981\u6ce8\u610f\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"rollout_batch_size * num_return_sequences_in_group \u5fc5\u987b\u662f\u4ee5\u4e0b\u503c\u7684\u6574\u6570\u500d\uff1a\ngradient_accumulation_steps * per_device_train_batch_size * (world_size/tensor_model_parallel_size/pipeline_model_parallel_size/context_parallel_size)\n"})}),"\n",(0,s.jsxs)(n.h3,{id:"\u5982\u4f55\u8bbe\u7f6e-gradient_accumulation_steps-\u548c-per_device_train_batch_size",children:["\u5982\u4f55\u8bbe\u7f6e ",(0,s.jsx)(n.code,{children:"gradient_accumulation_steps"})," \u548c ",(0,s.jsx)(n.code,{children:"per_device_train_batch_size"}),"\uff1f"]}),"\n",(0,s.jsx)(n.h4,{id:"\u5bf9\u4e8e-deepspeed-backend",children:"\u5bf9\u4e8e DeepSpeed Backend\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"global_batch_size = per_device_train_batch_size * gradient_accumulation_steps * world_size\n"})}),"\n",(0,s.jsxs)(n.p,{children:["\u5176\u4e2d ",(0,s.jsx)(n.code,{children:"world_size"})," \u5373 ",(0,s.jsx)(n.code,{children:"actor_train"}),"/",(0,s.jsx)(n.code,{children:"critic"})," \u7684 ",(0,s.jsx)(n.code,{children:"device_mapping"})," \u957f\u5ea6"]}),"\n",(0,s.jsx)(n.h4,{id:"\u5bf9\u4e8e-megatron-backend",children:"\u5bf9\u4e8e Megatron Backend\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"global_batch_size = per_device_train_batch_size * gradient_accumulation_steps * world_size / \n                    tensor_model_parallel_size / pipeline_model_parallel_size / context_parallel_size\n"})}),"\n",(0,s.jsxs)(n.p,{children:["\u5176\u4e2d ",(0,s.jsx)(n.code,{children:"world_size"})," \u5373 ",(0,s.jsx)(n.code,{children:"actor_train"}),"/",(0,s.jsx)(n.code,{children:"critic"})," \u7684 ",(0,s.jsx)(n.code,{children:"device_mapping"})," \u957f\u5ea6"]}),"\n",(0,s.jsxs)(n.p,{children:["\u6ce8\u610f\uff1a\u4e0d\u9700\u8981\u9664\u4ee5 ",(0,s.jsx)(n.code,{children:"expert_model_parallel_size"})]}),"\n",(0,s.jsx)(n.h2,{id:"\u8c03\u8bd5\u4e0e\u6027\u80fd\u5206\u6790\u76f8\u5173",children:"\u8c03\u8bd5\u4e0e\u6027\u80fd\u5206\u6790\u76f8\u5173"}),"\n",(0,s.jsx)(n.h3,{id:"\u5982\u4f55\u83b7\u53d6\u8bad\u7ec3\u7684-timeline",children:"\u5982\u4f55\u83b7\u53d6\u8bad\u7ec3\u7684 timeline\uff1f"}),"\n",(0,s.jsx)(n.p,{children:"\u53ef\u4ee5\u5c1d\u8bd5\u5728 YAML \u4e2d\u5f00\u542f profile\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'system_envs:\n  RAY_PROFILING: "1"\nprofiler_output_dir: /data/oss_bucket_0/yali/llm/profile/${exp_name}\n'})}),"\n",(0,s.jsxs)(n.p,{children:["\u7136\u540e\u5229\u7528 ",(0,s.jsx)(n.a,{href:"https://ui.perfetto.dev/",children:"Perfetto UI"})," \u5de5\u5177\u8fdb\u884c\u5206\u6790\u3002"]}),"\n",(0,s.jsx)(n.h3,{id:"\u5982\u4f55-debug-\u4ee3\u7801",children:"\u5982\u4f55 debug \u4ee3\u7801\uff1f"}),"\n",(0,s.jsxs)(n.p,{children:["\u5728 Platform \u7684 env \u4e2d\u8bbe\u7f6e ",(0,s.jsx)(n.code,{children:'"RAY_DEBUG": "legacy"'}),"\uff0c\u5c31\u53ef\u4ee5\u91c7\u7528 pdb \u8fdb\u884c\u5355\u6b65\u8c03\u8bd5\u3002"]}),"\n",(0,s.jsx)(n.h2,{id:"\u5e38\u89c1\u9519\u8bef\u53ca\u89e3\u51b3\u65b9\u6848",children:"\u5e38\u89c1\u9519\u8bef\u53ca\u89e3\u51b3\u65b9\u6848"}),"\n",(0,s.jsxs)(n.h3,{id:"\u9519\u8befselfnode2pgnode_rank-keyerror-1",children:["\u9519\u8bef\uff1a",(0,s.jsx)(n.code,{children:"self.node2pg[node_rank] KeyError: 1"})]}),"\n",(0,s.jsxs)(n.p,{children:["\u68c0\u67e5\u7533\u8bf7\u7684 GPU \u603b\u6570\u548c ",(0,s.jsx)(n.code,{children:"device_mapping"})," \u7684\u914d\u7f6e\u3002\u51fa\u73b0\u8be5\u9519\u8bef\u4e00\u822c\u662f\u56e0\u4e3a ",(0,s.jsx)(n.code,{children:"max(device_mapping)"})," \u5c0f\u4e8e\u6216\u5927\u4e8e ",(0,s.jsx)(n.code,{children:"total_gpu_nums"}),"\u3002"]}),"\n",(0,s.jsxs)(n.h3,{id:"\u9519\u8befassert-selflr_decay_steps--0",children:["\u9519\u8bef\uff1a",(0,s.jsx)(n.code,{children:"assert self.lr_decay_steps > 0"})]}),"\n",(0,s.jsxs)(n.p,{children:["ROLL \u6570\u636e\u5206\u914d\u65f6\uff0c\u4f1a\u5c06 ",(0,s.jsx)(n.code,{children:"rollout_batch_size"})," \u7684\u6837\u672c\u6309 DP size \u5206\u53d1\u5230\u6bcf\u4e2a ",(0,s.jsx)(n.code,{children:"actor_train"})," worker \u4e0a\uff0c\u7136\u540e\u518d\u6309 ",(0,s.jsx)(n.code,{children:"gradient_accumulation_steps"})," \u8ba1\u7b97\u6bcf\u6b21\u68af\u5ea6\u66f4\u65b0\u7684\u6837\u672c\u3002\u914d\u7f6e\u4e00\u9664\u5c31\u662f 0\u3002"]}),"\n",(0,s.jsxs)(n.p,{children:["\u8be6\u7ec6\u914d\u7f6e\u903b\u8f91\u53ef\u4ee5\u53c2\u8003\u624b\u518c\uff1a",(0,s.jsx)(n.a,{href:"https://alibaba.github.io/ROLL/docs/QuickStart/config_guide#training-arguments-training_args",children:"Training Arguments"})]}),"\n",(0,s.jsxs)(n.h3,{id:"\u9519\u8befassertionerror-batch_size-32--chunks-64",children:["\u9519\u8bef\uff1a",(0,s.jsx)(n.code,{children:"AssertionError: batch_size 32 < chunks 64"})]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"batch_size"})," \u5c0f\u4e8e ",(0,s.jsx)(n.code,{children:"reference"}),"/",(0,s.jsx)(n.code,{children:"actor_train"})," \u7684 DP size\uff0c\u5bfc\u81f4 dispatch \u65f6\u6570\u636e\u4e0d\u591f\u5207\u5206\uff0c\u53ef\u4ee5\u8c03\u6574 ",(0,s.jsx)(n.code,{children:"rollout_batch_size"})," \u89e3\u51b3\u3002"]}),"\n",(0,s.jsxs)(n.h3,{id:"\u9519\u8beftypeerror-backendcompilerfailed__init__-missing-1-required-positional-argument",children:["\u9519\u8bef\uff1a",(0,s.jsx)(n.code,{children:"TypeError: BackendCompilerFailed.__init__() missing 1 required positional argument"})]}),"\n",(0,s.jsx)(n.p,{children:"\u53ef\u4ee5\u5c1d\u8bd5\u5728 YAML \u4e2d\u589e\u52a0\u914d\u7f6e\u9879\u89e3\u51b3\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"system_envs:\n  NVTE_TORCH_COMPILE: '0'\n"})})]})}function _(e={}){const{wrapper:n}={...(0,c.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(o,{...e})}):o(e)}}}]);
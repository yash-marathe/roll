"use strict";(globalThis.webpackChunkdocs_roll=globalThis.webpackChunkdocs_roll||[]).push([[5004],{28453:(n,i,e)=>{e.d(i,{R:()=>a,x:()=>o});var l=e(96540);const r={},s=l.createContext(r);function a(n){const i=l.useContext(s);return l.useMemo(function(){return"function"==typeof n?n(i):{...i,...n}},[i,n])}function o(n){let i;return i=n.disableParentContext?"function"==typeof n.components?n.components(r):n.components||r:a(n.components),l.createElement(s.Provider,{value:i},n.children)}},51945:(n,i,e)=>{e.r(i),e.d(i,{assets:()=>t,contentTitle:()=>o,default:()=>d,frontMatter:()=>a,metadata:()=>l,toc:()=>c});const l=JSON.parse('{"id":"User Guides/Configuration/offpolicy_setting","title":"Off-Policy \u7b97\u6cd5\u914d\u7f6e\u6307\u5357","description":"ROLL \u6846\u67b6\u652f\u6301\u591a\u79cd Off-Policy \u7b97\u6cd5\u53d8\u4f53\uff0c\u7528\u4e8easync-training\u3002\u672c\u6587\u6863\u8be6\u7ec6\u4ecb\u7ecd\u5404\u79cd\u7b97\u6cd5\u7684\u914d\u7f6e\u65b9\u6cd5\u548c\u4f7f\u7528\u793a\u4f8b\u3002","source":"@site/i18n/zh-Hans/docusaurus-plugin-content-docs/current/User Guides/Configuration/offpolicy_setting.md","sourceDirName":"User Guides/Configuration","slug":"/User Guides/Configuration/offpolicy_setting","permalink":"/ROLL/zh-Hans/docs/User Guides/Configuration/offpolicy_setting","draft":false,"unlisted":false,"editUrl":"https://github.com/alibaba/ROLL/tree/main/docs_roll/docs/User Guides/Configuration/offpolicy_setting.md","tags":[],"version":"current","lastUpdatedAt":1764581625000,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Megatron \u63a8\u7406\u548c\u8bad\u7ec3\u540e\u7aef\u914d\u7f6e\u6307\u5357","permalink":"/ROLL/zh-Hans/docs/User Guides/Configuration/megatron"},"next":{"title":"SGLang \u63a8\u7406\u540e\u7aef\u914d\u7f6e\u6307\u5357","permalink":"/ROLL/zh-Hans/docs/User Guides/Configuration/sglang"}}');var r=e(74848),s=e(28453);const a={},o="Off-Policy \u7b97\u6cd5\u914d\u7f6e\u6307\u5357",t={},c=[{value:"\u652f\u6301\u7684\u7b97\u6cd5\u53d8\u4f53",id:"\u652f\u6301\u7684\u7b97\u6cd5\u53d8\u4f53",level:2},{value:"\u57fa\u7840\u914d\u7f6e",id:"\u57fa\u7840\u914d\u7f6e",level:2},{value:"\u6838\u5fc3\u53c2\u6570",id:"\u6838\u5fc3\u53c2\u6570",level:3},{value:"Worker \u914d\u7f6e",id:"worker-\u914d\u7f6e",level:3},{value:"\u5404\u7b97\u6cd5\u8be6\u7ec6\u914d\u7f6e",id:"\u5404\u7b97\u6cd5\u8be6\u7ec6\u914d\u7f6e",level:2},{value:"1. Vanilla Policy Gradient",id:"1-vanilla-policy-gradient",level:3},{value:"2. PPO (Proximal Policy Optimization)",id:"2-ppo-proximal-policy-optimization",level:3},{value:"3. TIS (Truncated Importance Sampling)",id:"3-tis-truncated-importance-sampling",level:3},{value:"4. TOPR (Tapered off-policy REINFORCE)",id:"4-topr-tapered-off-policy-reinforce",level:3},{value:"5. CISPO (Clipped Importance Sampling Policy Optimization)",id:"5-cispo-clipped-importance-sampling-policy-optimization",level:3},{value:"6. Kimi15",id:"6-kimi15",level:3},{value:"\u5b8c\u6574\u914d\u7f6e\u793a\u4f8b",id:"\u5b8c\u6574\u914d\u7f6e\u793a\u4f8b",level:2}];function p(n){const i={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...n.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(i.header,{children:(0,r.jsx)(i.h1,{id:"off-policy-\u7b97\u6cd5\u914d\u7f6e\u6307\u5357",children:"Off-Policy \u7b97\u6cd5\u914d\u7f6e\u6307\u5357"})}),"\n",(0,r.jsx)(i.p,{children:"ROLL \u6846\u67b6\u652f\u6301\u591a\u79cd Off-Policy \u7b97\u6cd5\u53d8\u4f53\uff0c\u7528\u4e8easync-training\u3002\u672c\u6587\u6863\u8be6\u7ec6\u4ecb\u7ecd\u5404\u79cd\u7b97\u6cd5\u7684\u914d\u7f6e\u65b9\u6cd5\u548c\u4f7f\u7528\u793a\u4f8b\u3002"}),"\n",(0,r.jsx)(i.h2,{id:"\u652f\u6301\u7684\u7b97\u6cd5\u53d8\u4f53",children:"\u652f\u6301\u7684\u7b97\u6cd5\u53d8\u4f53"}),"\n",(0,r.jsx)(i.p,{children:"ROLL \u6846\u67b6\u76ee\u524d\u652f\u6301\u4ee5\u4e0b Off-Policy \u7b97\u6cd5\uff1a"}),"\n",(0,r.jsxs)(i.ol,{children:["\n",(0,r.jsxs)(i.li,{children:[(0,r.jsx)(i.strong,{children:"vanilla"})," - \u57fa\u7840 Policy Gradient \u7b97\u6cd5"]}),"\n",(0,r.jsxs)(i.li,{children:[(0,r.jsx)(i.strong,{children:"ppo"})," - Proximal Policy Optimization"]}),"\n",(0,r.jsxs)(i.li,{children:[(0,r.jsx)(i.strong,{children:"tis"})," - Truncated Importance Sampling"]}),"\n",(0,r.jsxs)(i.li,{children:[(0,r.jsx)(i.strong,{children:"topr"})," - Tapered off-policy REINFORCE"]}),"\n",(0,r.jsxs)(i.li,{children:[(0,r.jsx)(i.strong,{children:"cispo"})," - Clipped Importance Sampling Policy Optimization"]}),"\n",(0,r.jsxs)(i.li,{children:[(0,r.jsx)(i.strong,{children:"kimi15"})," - Kimi15 \u7b97\u6cd5"]}),"\n"]}),"\n",(0,r.jsx)(i.h2,{id:"\u57fa\u7840\u914d\u7f6e",children:"\u57fa\u7840\u914d\u7f6e"}),"\n",(0,r.jsx)(i.h3,{id:"\u6838\u5fc3\u53c2\u6570",children:"\u6838\u5fc3\u53c2\u6570"}),"\n",(0,r.jsx)(i.p,{children:"\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u8bbe\u7f6e Off-Policy \u7b97\u6cd5\u7684\u57fa\u672c\u53c2\u6570\uff1a"}),"\n",(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{className:"language-yaml",children:'# \u9009\u62e9\u7b97\u6cd5\u53d8\u4f53\npg_variant: topr  # \u53ef\u9009: vanilla, tis, topr, cispo, kimi15, ppo\n\n# \u8bad\u7ec3\u914d\u7f6e\nmax_steps: 500\nsave_steps: 100\nlogging_steps: 1\neval_steps: 10\n\n# \u6570\u636e\u914d\u7f6e\nrollout_batch_size: 128\nprompt_length: 2048\nresponse_length: 8192\nnum_return_sequences_in_group: 8\n\n# \u901a\u7528\u8bad\u7ec3\u53c2\u6570\nppo_epochs: 1\nadv_estimator: "reinforce"\nwhiten_advantages: true\n'})}),"\n",(0,r.jsx)(i.h3,{id:"worker-\u914d\u7f6e",children:"Worker \u914d\u7f6e"}),"\n",(0,r.jsx)(i.p,{children:"\u4f7f\u7528\u4e13\u95e8\u7684 ActorPGWorker \u6765\u5904\u7406 Off-Policy \u7b97\u6cd5\uff1a"}),"\n",(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{className:"language-yaml",children:"actor_train:\n  worker_cls: roll.pipeline.rlvr.actor_pg_worker.ActorPGWorker\n  pg_variant: topr  # \u4e0e\u5168\u5c40\u914d\u7f6e\u4fdd\u6301\u4e00\u81f4\n  model_args:\n    flash_attn: fa2\n    disable_gradient_checkpointing: false\n    dtype: bf16\n  training_args:\n    learning_rate: 1.0e-6\n    weight_decay: 0\n    per_device_train_batch_size: 1\n    gradient_accumulation_steps: 64\n    warmup_steps: 20\n    num_train_epochs: 50\n  strategy_args:\n    strategy_name: megatron_train\n    strategy_config:\n      tensor_model_parallel_size: 1\n      pipeline_model_parallel_size: 1\n      use_distributed_optimizer: true\n      recompute_granularity: full\n  device_mapping: list(range(0,16))\n"})}),"\n",(0,r.jsx)(i.h2,{id:"\u5404\u7b97\u6cd5\u8be6\u7ec6\u914d\u7f6e",children:"\u5404\u7b97\u6cd5\u8be6\u7ec6\u914d\u7f6e"}),"\n",(0,r.jsx)(i.h3,{id:"1-vanilla-policy-gradient",children:"1. Vanilla Policy Gradient"}),"\n",(0,r.jsx)(i.p,{children:"\u6700\u57fa\u7840\u7684\u7b56\u7565\u68af\u5ea6\u7b97\u6cd5\uff0c\u76f4\u63a5\u4f7f\u7528 log \u6982\u7387\u548c\u4f18\u52bf\u51fd\u6570\u7684\u4e58\u79ef\u4f5c\u4e3a\u635f\u5931\u3002"}),"\n",(0,r.jsx)(i.p,{children:(0,r.jsx)(i.strong,{children:"\u914d\u7f6e\u7279\u70b9\uff1a"})}),"\n",(0,r.jsxs)(i.ul,{children:["\n",(0,r.jsx)(i.li,{children:"\u65e0\u9700\u989d\u5916\u53c2\u6570"}),"\n",(0,r.jsx)(i.li,{children:"\u8ba1\u7b97\u6548\u7387\u9ad8"}),"\n",(0,r.jsx)(i.li,{children:"\u9002\u5408\u7b80\u5355\u7684\u5f3a\u5316\u5b66\u4e60\u4efb\u52a1"}),"\n"]}),"\n",(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{className:"language-yaml",children:"pg_variant: vanilla\n\n# \u65e0\u9700\u989d\u5916\u914d\u7f6e\u53c2\u6570\n"})}),"\n",(0,r.jsx)(i.h3,{id:"2-ppo-proximal-policy-optimization",children:"2. PPO (Proximal Policy Optimization)"}),"\n",(0,r.jsx)(i.p,{children:"\u8fd1\u7aef\u7b56\u7565\u4f18\u5316\u7b97\u6cd5\uff0c\u901a\u8fc7\u88c1\u526a\u91cd\u8981\u6027\u91c7\u6837\u6bd4\u7387\u6765\u7a33\u5b9a\u8bad\u7ec3\u3002"}),"\n",(0,r.jsx)(i.p,{children:(0,r.jsx)(i.strong,{children:"\u5173\u952e\u53c2\u6570\uff1a"})}),"\n",(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{className:"language-yaml",children:"pg_variant: ppo\n\n# PPO \u7279\u5b9a\u53c2\u6570\npg_clip: 0.2                    # \u88c1\u526a\u8303\u56f4\npg_clip_low: 0.2               # \u4e0b\u754c\u88c1\u526a\uff08\u53ef\u9009\uff09\npg_clip_high: 0.2              # \u4e0a\u754c\u88c1\u526a\uff08\u53ef\u9009\uff09\nuse_pg_clip_range: false       # \u662f\u5426\u4f7f\u7528\u4e0d\u5bf9\u79f0\u88c1\u526a\ndual_clip_loss: true           # \u662f\u5426\u542f\u7528\u53cc\u91cd\u88c1\u526a\n"})}),"\n",(0,r.jsx)(i.p,{children:(0,r.jsx)(i.strong,{children:"\u914d\u7f6e\u793a\u4f8b\uff1a"})}),"\n",(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{className:"language-yaml",children:"pg_variant: ppo\npg_clip: 0.2\ndual_clip_loss: true\n"})}),"\n",(0,r.jsx)(i.h3,{id:"3-tis-truncated-importance-sampling",children:"3. TIS (Truncated Importance Sampling)"}),"\n",(0,r.jsx)(i.p,{children:"\u622a\u65ad\u91cd\u8981\u6027\u91c7\u6837\u7b97\u6cd5\uff0c\u5c06\u91cd\u8981\u6027\u91c7\u6837\u6bd4\u7387\u9650\u5236\u5728 [0, 1] \u8303\u56f4\u5185\u3002"}),"\n",(0,r.jsx)(i.p,{children:(0,r.jsx)(i.strong,{children:"\u5173\u952e\u53c2\u6570\uff1a"})}),"\n",(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{className:"language-yaml",children:"pg_variant: tis\n\n# TIS \u7279\u5b9a\u53c2\u6570\ntis_lower_bound: 0.0           # \u4e0b\u754c\ntis_upper_bound: 1.0           # \u4e0a\u754c\n"})}),"\n",(0,r.jsx)(i.p,{children:(0,r.jsx)(i.strong,{children:"\u914d\u7f6e\u793a\u4f8b\uff1a"})}),"\n",(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{className:"language-yaml",children:"pg_variant: tis\ntis_lower_bound: 0.0\ntis_upper_bound: 1.0\n"})}),"\n",(0,r.jsx)(i.h3,{id:"4-topr-tapered-off-policy-reinforce",children:"4. TOPR (Tapered off-policy REINFORCE)"}),"\n",(0,r.jsx)(i.p,{children:"\u9525\u5f62\u79bb\u7b56\u7565\u5f3a\u5316\u5b66\u4e60\u7b97\u6cd5\uff0c\u6839\u636e\u5956\u52b1\u7684\u6b63\u8d1f\u5206\u522b\u91c7\u7528\u4e0d\u540c\u7684\u66f4\u65b0\u7b56\u7565\u3002"}),"\n",(0,r.jsx)(i.p,{children:(0,r.jsx)(i.strong,{children:"\u7b97\u6cd5\u7279\u70b9\uff1a"})}),"\n",(0,r.jsxs)(i.ul,{children:["\n",(0,r.jsx)(i.li,{children:"\u6b63\u6837\u672c\uff1a\u76f4\u63a5 SFT \u66f4\u65b0\uff0c\u4e0d\u4f7f\u7528\u91cd\u8981\u6027\u91c7\u6837"}),"\n",(0,r.jsx)(i.li,{children:"\u8d1f\u6837\u672c\uff1a\u4f7f\u7528 TIS \u66f4\u65b0\uff0c\u9650\u5236\u91cd\u8981\u6027\u91c7\u6837\u6bd4\u7387\u5728 [0, 1]"}),"\n"]}),"\n",(0,r.jsx)(i.p,{children:(0,r.jsx)(i.strong,{children:"\u5173\u952e\u53c2\u6570\uff1a"})}),"\n",(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{className:"language-yaml",children:"pg_variant: topr\n\n# TOPR \u7279\u5b9a\u53c2\u6570\ntopr_positive_weight: 1.0      # \u6b63\u6837\u672c\u6743\u91cd\ntopr_negative_weight: 1.0      # \u8d1f\u6837\u672c\u6743\u91cd\n"})}),"\n",(0,r.jsx)(i.p,{children:(0,r.jsx)(i.strong,{children:"\u914d\u7f6e\u793a\u4f8b\uff1a"})}),"\n",(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{className:"language-yaml",children:"pg_variant: topr\ntopr_positive_weight: 1.0\ntopr_negative_weight: 1.0\n"})}),"\n",(0,r.jsx)(i.h3,{id:"5-cispo-clipped-importance-sampling-policy-optimization",children:"5. CISPO (Clipped Importance Sampling Policy Optimization)"}),"\n",(0,r.jsx)(i.p,{children:"\u622a\u65ad\u91cd\u8981\u6027\u91c7\u6837\u7b56\u7565\u4f18\u5316\u7b97\u6cd5\uff0c\u4f7f\u7528\u622a\u65ad\u7684\u91cd\u8981\u6027\u91c7\u6837\u6743\u91cd\u548c stop-gradient \u64cd\u4f5c\u3002"}),"\n",(0,r.jsx)(i.p,{children:(0,r.jsx)(i.strong,{children:"\u5173\u952e\u53c2\u6570\uff1a"})}),"\n",(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{className:"language-yaml",children:"pg_variant: cispo\n\n# CISPO \u7279\u5b9a\u53c2\u6570\ncispo_epsilon_low: 0.1         # \u4e0b\u754c\u88c1\u526a\u53c2\u6570\ncispo_epsilon_high: 0.1        # \u4e0a\u754c\u88c1\u526a\u53c2\u6570\ncispo_use_unified_mask: false  # \u662f\u5426\u4f7f\u7528\u7edf\u4e00\u63a9\u7801\n"})}),"\n",(0,r.jsx)(i.p,{children:(0,r.jsx)(i.strong,{children:"\u914d\u7f6e\u793a\u4f8b\uff1a"})}),"\n",(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{className:"language-yaml",children:"pg_variant: cispo\ncispo_epsilon_low: 0.1\ncispo_epsilon_high: 0.1\ncispo_use_unified_mask: false\n"})}),"\n",(0,r.jsx)(i.h3,{id:"6-kimi15",children:"6. Kimi15"}),"\n",(0,r.jsx)(i.p,{children:"\u57fa\u4e8e KL \u6b63\u5219\u5316\u7684\u7b56\u7565\u68af\u5ea6\u7b97\u6cd5\uff0c\u5728\u7b56\u7565\u68af\u5ea6\u9879\u4e2d\u52a0\u5165 KL \u6563\u5ea6\u6b63\u5219\u5316\u9879\u3002"}),"\n",(0,r.jsx)(i.p,{children:(0,r.jsx)(i.strong,{children:"\u5173\u952e\u53c2\u6570\uff1a"})}),"\n",(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{className:"language-yaml",children:"pg_variant: kimi15\n\n# Kimi15 \u7279\u5b9a\u53c2\u6570\nkimi15_tau: 0.1               # \u6b63\u5219\u5316\u53c2\u6570\n"})}),"\n",(0,r.jsx)(i.p,{children:(0,r.jsx)(i.strong,{children:"\u914d\u7f6e\u793a\u4f8b\uff1a"})}),"\n",(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{className:"language-yaml",children:"pg_variant: kimi15\nkimi15_tau: 0.1\n"})}),"\n",(0,r.jsx)(i.h2,{id:"\u5b8c\u6574\u914d\u7f6e\u793a\u4f8b",children:"\u5b8c\u6574\u914d\u7f6e\u793a\u4f8b"}),"\n",(0,r.jsx)(i.p,{children:"RLVR Off-Policy \u914d\u7f6e\u793a\u4f8b\u53c2\u8003: examples/qwen2.5-7B-rlvr-offpolicy/rlvr_config.yaml"})]})}function d(n={}){const{wrapper:i}={...(0,s.R)(),...n.components};return i?(0,r.jsx)(i,{...n,children:(0,r.jsx)(p,{...n})}):p(n)}}}]);